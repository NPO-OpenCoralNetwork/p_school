<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Éñ„É≠„ÉÉ„ÇØ„Éê„Éà„É´„Ç≤„Éº„É†</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    #playerHP, #enemyHP {
      margin: 5px;
      font-weight: bold;
      color: #333;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #ffffff;
      text-align: center;
      margin: 15px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-size: 2.5em;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .game-container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      gap: 20px;
      padding: 20px;
    }

    .game-area {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .editor-area {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    #gameCanvas {
      border: 3px solid #667eea;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    #blocklyDiv {
      border: 2px solid #764ba2;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    #runButton {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    #runButton:hover {
      background: linear-gradient(45deg, #45a049, #4CAF50);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
    #loginScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .login-container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
      min-width: 350px;
    }

    .login-container h2 {
      color: #333;
      margin-bottom: 30px;
      text-shadow: none;
    }

    .login-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    .login-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      margin: 15px 10px;
      transition: all 0.3s ease;
      min-width: 120px;
    }

    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    .login-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .signup-button {
      background: linear-gradient(45deg, #4CAF50, #45a049);
    }

    /* Êñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É† */
    .signup-form {
      display: none;
    }

    .signup-form.active {
      display: block;
    }

    /* „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫„Ç®„É™„Ç¢ */
    .profile-area {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .profile-toggle {
      background: linear-gradient(45deg, #FF6B6B, #FF8E53);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .profile-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .profile-content {
      display: none;
      animation: slideDown 0.3s ease;
    }

    .profile-content.visible {
      display: block;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .profile-item {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }

    .profile-label {
      font-weight: bold;
      color: #555;
    }

    .profile-value {
      color: #333;
    }

    .exp-bar-container {
      margin: 10px 0;
    }

    .exp-bar-bg {
      background: #ddd;
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
    }

    .exp-bar {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      height: 100%;
      border-radius: 5px;
      transition: width 0.5s ease;
      width: 0%;
    }

    .badges-container {
      margin-top: 10px;
    }

    .badge {
      display: inline-block;
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #333;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
    @media (max-width: 1200px) {
      .game-container {
        flex-direction: column;
      }
      
      #gameCanvas {
        width: 100%;
        height: auto;
      }
    }

    /* „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥ */
    .logout-button {
      background: linear-gradient(45deg, #f44336, #e53935);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 10px;
      transition: all 0.3s ease;
    }

    .logout-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .form-toggle {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
    }

    .form-toggle a {
      color: #667eea;
      text-decoration: none;
      cursor: pointer;
    }

    .form-toggle a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
  <div id="loginScreen">
    <div class="login-container">
      <h2>üéÆ „Éñ„É≠„ÉÉ„ÇØ„Éê„Éà„É´„Ç≤„Éº„É†</h2>
      
      <!-- „É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É† -->
      <div id="loginForm" class="login-form">
        <p>„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ</p>
        
        <input type="email" id="loginEmail" class="login-input" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" required>
        <input type="password" id="loginPassword" class="login-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" required>
        
        <div>
          <button id="loginButton" class="login-button">„É≠„Ç∞„Ç§„É≥</button>
        </div>
        
        <div class="form-toggle">
          ÂàùÂõû„ÅÆÊñπ„ÅØ <a id="showSignupForm">Êñ∞Ë¶èÁôªÈå≤</a>
        </div>
      </div>

      <!-- Êñ∞Ë¶èÁôªÈå≤„Éï„Ç©„Éº„É† -->
      <div id="signupForm" class="signup-form">
        <p>Êñ∞Ë¶è„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩúÊàê</p>
        
        <input type="text" id="signupUsername" class="login-input" placeholder="„É¶„Éº„Ç∂„ÉºÂêç" required>
        <input type="text" id="signupName" class="login-input" placeholder="Ë°®Á§∫Âêç" required>
        <input type="email" id="signupEmail" class="login-input" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" required>
        <input type="password" id="signupPassword" class="login-input" placeholder="„Éë„Çπ„ÉØ„Éº„ÉâÔºà6ÊñáÂ≠ó‰ª•‰∏äÔºâ" required>
        
        <div>
          <button id="signupButton" class="login-button signup-button">Êñ∞Ë¶èÁôªÈå≤</button>
        </div>
        
        <div class="form-toggle">
          Êó¢„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„ÅÆÊñπ„ÅØ <a id="showLoginForm">„É≠„Ç∞„Ç§„É≥</a>
        </div>
      </div>
      
      <div id="authError" style="color: red; margin-top: 10px; display: none;"></div>
      <div id="authSuccess" style="color: green; margin-top: 10px; display: none;"></div>
    </div>
  </div>

  <!-- „É°„Ç§„É≥„Ç≤„Éº„É†ÁîªÈù¢ -->
  <div id="gameScreen" style="display: none;">
    <h1>„Éñ„É≠„ÉÉ„ÇØ„Åß‰Ωú„ÇãÂØæÊà¶„Ç≤„Éº„É†</h1>
    
    <div class="game-container">
      <div class="game-area">
        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <!-- HP„Éê„Éº -->
        <div>
          <div id="playerHP">Player: 100</div>
          <div id="enemyHP">Enemy: 50</div>
        </div>

        <!-- „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫„Ç®„É™„Ç¢ -->
        <div class="profile-area">
          <button id="profileToggle" class="profile-toggle">üë§ „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫</button>
          
          <div id="profileContent" class="profile-content">
            <div class="profile-item">
              <span class="profile-label">„Éó„É¨„Ç§„É§„ÉºÂêç:</span>
              <span id="profileName" class="profile-value">-</span>
              <button id="logoutButton" class="logout-button">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </div>
            
            <div class="profile-item">
              <span class="profile-label">„É¨„Éô„É´:</span>
              <span id="profileLevel" class="profile-value">Lv.0</span>
            </div>
            
            <div class="profile-item">
              <span class="profile-label">ÁµåÈ®ìÂÄ§:</span>
              <span id="profileExp" class="profile-value">0</span>
            </div>
            
            <div class="exp-bar-container">
              <div class="exp-bar-bg">
                <div id="expBar" class="exp-bar"></div>
              </div>
              <small id="expToNext">Ê¨°„ÅÆ„É¨„Éô„É´„Åæ„Åß: 100</small>
            </div>
            
            <div class="profile-item">
              <span class="profile-label">üèÜ „Éà„É≠„Éï„Ç£„Éº:</span>
              <span id="profileTrophies" class="profile-value">0</span>
            </div>
            
            <div class="badges-container">
              <div class="profile-label" style="margin-bottom: 5px;">üéñÔ∏è „Éê„ÉÉ„Ç∏:</div>
              <div id="profileBadges"></div>
            </div>
          </div>
        </div>
      </div>
        
      <div class="editor-area">
        <!-- „Éñ„É≠„ÉÉ„ÇØ„Ç®„Éá„Ç£„Çø -->
        <div id="blocklyDiv"></div>
        <button id="runButton">üöÄ ÂÆüË°å</button>
      </div>
    </div>
  </div>
  
  <xml id="toolbox" style="display: none"></xml>

  <!-- JavaScriptÈÉ®ÂàÜ -->
  <script type="module">
    // Êó¢Â≠ò„ÅÆSupabaseÈñ¢Êï∞„Çíimport
    import { signIn, signUp, signOut, getProfile, updateExperience, addBadge } from './lib/profile.js';

    // „É≠„Ç∞„Ç§„É≥„Éª„Éó„É≠„Éï„Ç£„Éº„É´ÁÆ°ÁêÜ
    class GameLoginManager {
      constructor() {
        this.currentProfile = null;
        this.setupEventListeners();
      }

      setupEventListeners() {
        // „É≠„Ç∞„Ç§„É≥„Éú„Çø„É≥
        document.getElementById('loginButton').addEventListener('click', () => {
          this.handleLogin();
        });

        // Êñ∞Ë¶èÁôªÈå≤„Éú„Çø„É≥
        document.getElementById('signupButton').addEventListener('click', () => {
          this.handleSignup();
        });

        // „É≠„Ç∞„Ç¢„Ç¶„Éà„Éú„Çø„É≥
        document.getElementById('logoutButton').addEventListener('click', () => {
          this.handleLogout();
        });

        // „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫Âàá„ÇäÊõø„Åà
        document.getElementById('profileToggle').addEventListener('click', () => {
          this.toggleProfile();
        });

        // „Éï„Ç©„Éº„É†Âàá„ÇäÊõø„Åà
        document.getElementById('showSignupForm').addEventListener('click', () => {
          this.showSignupForm();
        });

        document.getElementById('showLoginForm').addEventListener('click', () => {
          this.showLoginForm();
        });

        // „Ç®„É≥„Çø„Éº„Ç≠„Éº„Åß„É≠„Ç∞„Ç§„É≥
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.handleLogin();
          }
        });

        document.getElementById('signupPassword').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.handleSignup();
          }
        });
      }

      showSignupForm() {
        document.getElementById('loginForm').classList.remove('active');
        document.getElementById('signupForm').classList.add('active');
        this.clearMessages();
      }

      showLoginForm() {
        document.getElementById('signupForm').classList.remove('active');
        document.getElementById('loginForm').classList.add('active');
        this.clearMessages();
      }

      async handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const button = document.getElementById('loginButton');

        if (!email || !password) {
          this.showError('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }

        try {
          // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
          button.disabled = true;
          button.innerHTML = '„É≠„Ç∞„Ç§„É≥‰∏≠... <div class="loading"></div>';

          // ÂÆüÈöõ„ÅÆSupabaseË™çË®º
          const user = await signIn(email, password);
          console.log('„É≠„Ç∞„Ç§„É≥ÊàêÂäü:', user);

          // „Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó
          this.currentProfile = await getProfile();
          console.log('„Éó„É≠„Éï„Ç£„Éº„É´ÂèñÂæó:', this.currentProfile);

          this.showGameScreen();
          this.clearMessages();

        } catch (error) {
          console.error('„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:', error);
          this.showError('„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
        } finally {
          button.disabled = false;
          button.innerHTML = '„É≠„Ç∞„Ç§„É≥';
        }
      }

      async handleSignup() {
        const username = document.getElementById('signupUsername').value;
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const button = document.getElementById('signupButton');

        if (!username || !name || !email || !password) {
          this.showError('ÂÖ®„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }

        if (password.length < 6) {
          this.showError('„Éë„Çπ„ÉØ„Éº„Éâ„ÅØ6ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
          return;
        }

        try {
          // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
          button.disabled = true;
          button.innerHTML = 'ÁôªÈå≤‰∏≠... <div class="loading"></div>';

          // ÂÆüÈöõ„ÅÆSupabaseÊñ∞Ë¶èÁôªÈå≤
          const user = await signUp(email, password, username, name);
          console.log('Êñ∞Ë¶èÁôªÈå≤ÊàêÂäü:', user);

          this.showSuccess('ÁôªÈå≤„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ„É°„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÊúâÂäπÂåñ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          
          // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„É≠„Ç∞„Ç§„É≥„Éï„Ç©„Éº„É†„Å´Âàá„ÇäÊõø„Åà
          setTimeout(() => {
            this.showLoginForm();
            document.getElementById('loginEmail').value = email;
          }, 2000);

        } catch (error) {
          console.error('Êñ∞Ë¶èÁôªÈå≤„Ç®„É©„Éº:', error);
          this.showError('Êñ∞Ë¶èÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
        } finally {
          button.disabled = false;
          button.innerHTML = 'Êñ∞Ë¶èÁôªÈå≤';
        }
      }

      async handleLogout() {
        try {
          await signOut();
          this.currentProfile = null;
          document.getElementById('loginScreen').style.display = 'flex';
          document.getElementById('gameScreen').style.display = 'none';
          
          // „Éï„Ç©„Éº„É†„Çí„ÇØ„É™„Ç¢
          document.getElementById('loginEmail').value = '';
          document.getElementById('loginPassword').value = '';
          document.getElementById('signupUsername').value = '';
          document.getElementById('signupName').value = '';
          document.getElementById('signupEmail').value = '';
          document.getElementById('signupPassword').value = '';
          
          this.showLoginForm();
          this.clearMessages();
          
        } catch (error) {
          console.error('„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:', error);
        }
      }

      showGameScreen() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        this.updateProfileDisplay();
      }

      showError(message) {
        const errorDiv = document.getElementById('authError');
        const successDiv = document.getElementById('authSuccess');
        successDiv.style.display = 'none';
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }

      showSuccess(message) {
        const errorDiv = document.getElementById('authError');
        const successDiv = document.getElementById('authSuccess');
        errorDiv.style.display = 'none';
        successDiv.textContent = message;
        successDiv.style.display = 'block';
      }

      clearMessages() {
        document.getElementById('authError').style.display = 'none';
        document.getElementById('authSuccess').style.display = 'none';
      }

      toggleProfile() {
        const content = document.getElementById('profileContent');
        const button = document.getElementById('profileToggle');
        
        if (content.classList.contains('visible')) {
          content.classList.remove('visible');
          button.textContent = 'üë§ „Éó„É≠„Éï„Ç£„Éº„É´Ë°®Á§∫';
        } else {
          content.classList.add('visible');
          button.textContent = 'üë§ „Éó„É≠„Éï„Ç£„Éº„É´ÈùûË°®Á§∫';
          this.updateProfileDisplay();
        }
      }

      updateProfileDisplay() {
        if (!this.currentProfile) return;

        const currentLevel = Math.floor(this.currentProfile.experience_points / 100);
        const currentLevelExp = this.currentProfile.experience_points - (currentLevel * 100);
        const expToNext = 100 - currentLevelExp;
        const expPercentage = (currentLevelExp / 100) * 100;

        document.getElementById('profileName').textContent = this.currentProfile.name;
        document.getElementById('profileLevel').textContent = `Lv.${currentLevel}`;
        document.getElementById('profileExp').textContent = this.currentProfile.experience_points;
        document.getElementById('profileTrophies').textContent = this.currentProfile.trophy_count;
        document.getElementById('expToNext').textContent = `Ê¨°„ÅÆ„É¨„Éô„É´„Åæ„Åß: ${expToNext}`;
        document.getElementById('expBar').style.width = `${expPercentage}%`;

        // „Éê„ÉÉ„Ç∏Ë°®Á§∫
        const badgesContainer = document.getElementById('profileBadges');
        badgesContainer.innerHTML = '';
        if (this.currentProfile.badges && this.currentProfile.badges.length > 0) {
          this.currentProfile.badges.forEach(badge => {
            const badgeElement = document.createElement('span');
            badgeElement.className = 'badge';
            badgeElement.textContent = badge;
            badgesContainer.appendChild(badgeElement);
          });
        } else {
          badgesContainer.innerHTML = '<span style="color: #999; font-size: 12px;">„Åæ„Å†„Éê„ÉÉ„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</span>';
        }
      }

      // „Éê„Éà„É´ÂãùÂà©ÊôÇ„ÅÆÁµåÈ®ìÂÄ§ËøΩÂä†
      async addExperience(points) {
        if (!this.currentProfile) return;

        try {
          const oldLevel = Math.floor(this.currentProfile.experience_points / 100);
          const newExpPoints = this.currentProfile.experience_points + points;
          
          // „Éá„Éº„Çø„Éô„Éº„ÇπÊõ¥Êñ∞
          const updatedProfile = await updateExperience(newExpPoints);
          
          if (updatedProfile && updatedProfile.length > 0) {
            this.currentProfile = updatedProfile[0];
            
            const newLevel = Math.floor(this.currentProfile.experience_points / 100);

            // „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ
            if (newLevel > oldLevel) {
              await this.handleLevelUp(newLevel);
              this.showLevelUpEffect(newLevel);
            }

            this.updateProfileDisplay();
            return { levelUp: newLevel > oldLevel, newLevel, earnedExp: points };
          }
        } catch (error) {
          console.error('ÁµåÈ®ìÂÄ§Êõ¥Êñ∞„Ç®„É©„Éº:', error);
        }
      }

      async handleLevelUp(newLevel) {
        try {
          // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Éê„ÉÉ„Ç∏
          const levelBadges = {
            5: '„É¨„Éô„É´5ÈÅîÊàê',
            10: '„É¨„Éô„É´10ÈÅîÊàê',
            20: '„É¨„Éô„É´20ÈÅîÊàê',
            50: '„É¨„Éô„É´50ÈÅîÊàê'
          };

          if (levelBadges[newLevel]) {
            const updatedProfile = await addBadge(levelBadges[newLevel]);
            if (updatedProfile && updatedProfile.length > 0) {
              this.currentProfile = updatedProfile[0];
            }
          }
        } catch (error) {
          console.error('„É¨„Éô„É´„Ç¢„ÉÉ„Éó„Éê„ÉÉ„Ç∏ËøΩÂä†„Ç®„É©„Éº:', error);
        }
      }

      showLevelUpEffect(newLevel) {
        // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
        const popup = document.createElement('div');
        popup.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: linear-gradient(45deg, #FFD700, #FFA500);
          color: #333;
          padding: 30px;
          border-radius: 15px;
          font-size: 24px;
          font-weight: bold;
          text-align: center;
          z-index: 2000;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          animation: levelUpPulse 2s ease-in-out;
        `;
        popup.innerHTML = `üéâ<br>LEVEL UP!<br>Lv.${newLevel}`;

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ CSS „ÇíËøΩÂä†
        const style = document.createElement('style');
        style.textContent = `
          @keyframes levelUpPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
          }
        `;
        document.head.appendChild(style);

        document.body.appendChild(popup);

        setTimeout(() => {
          document.body.removeChild(popup);
          document.head.removeChild(style);
        }, 2000);
      }
    }

    // „Ç≤„Éº„É†ÂàùÊúüÂåñ
    window.gameLoginManager = new GameLoginManager();

    // Êó¢Â≠ò„ÅÆindex.js„Åã„ÇâÂëº„Å≥Âá∫„Åï„Çå„ÇãÈñ¢Êï∞Ôºà„Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨ÈñãÔºâ
    window.addGameExperience = (points) => {
      return window.gameLoginManager.addExperience(points);
    };

    // „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÊôÇ„ÅÆ„Éê„ÉÉ„Ç∏ËøΩÂä†Èñ¢Êï∞„ÇÇÂÖ¨Èñã
    window.addStageBadge = async (stageName) => {
      if (window.gameLoginManager.currentProfile) {
        try {
          const badgeName = `${stageName}ÂàùÂõû„ÇØ„É™„Ç¢`;
          const updatedProfile = await addBadge(badgeName);
          if (updatedProfile && updatedProfile.length > 0) {
            window.gameLoginManager.currentProfile = updatedProfile[0];
            window.gameLoginManager.updateProfileDisplay();
          }
        } catch (error) {
          console.error('„Çπ„ÉÜ„Éº„Ç∏„Éê„ÉÉ„Ç∏ËøΩÂä†„Ç®„É©„Éº:', error);
        }
      }
    };
  </script>
</body>
</html>