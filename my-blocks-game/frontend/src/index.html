<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒˆãƒ«ã‚²ãƒ¼ãƒ </title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    #playerHP, #enemyHP {
      margin: 5px;
      font-weight: bold;
      color: #333;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 12px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h1 {
      color: #ffffff;
      text-align: center;
      margin: 15px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-size: 2.5em;
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .game-container {
      display: flex;
      max-width: 1400px;
      margin: 0 auto;
      gap: 20px;
      padding: 20px;
    }

    .game-area {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .editor-area {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    #gameCanvas {
      border: 3px solid #667eea;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    #blocklyDiv {
      border: 2px solid #764ba2;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    #runButton {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    #runButton:hover {
      background: linear-gradient(45deg, #45a049, #4CAF50);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #loginScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .login-container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
      min-width: 350px;
    }

    .login-container h2 {
      color: #333;
      margin-bottom: 30px;
      text-shadow: none;
    }

    .login-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }

    .login-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      margin: 15px 10px;
      transition: all 0.3s ease;
      min-width: 120px;
    }

    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    .login-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .signup-button {
      background: linear-gradient(45deg, #4CAF50, #45a049);
    }

    /* æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  */
    .signup-form {
      display: none;
    }

    .signup-form.active {
      display: block;
    }

    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .profile-area {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .profile-toggle {
      background: linear-gradient(45deg, #FF6B6B, #FF8E53);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .profile-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .profile-content {
      display: none;
      animation: slideDown 0.3s ease;
    }

    .profile-content.visible {
      display: block;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .profile-item {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }

    .profile-label {
      font-weight: bold;
      color: #555;
    }

    .profile-value {
      color: #333;
    }

    .exp-bar-container {
      margin: 10px 0;
    }

    .exp-bar-bg {
      background: #ddd;
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
    }

    .exp-bar {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      height: 100%;
      border-radius: 5px;
      transition: width 0.5s ease;
      width: 0%;
    }

    .badges-container {
      margin-top: 10px;
    }

    .badge {
      display: inline-block;
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #333;
      padding: 4px 8px;
      margin: 2px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 1200px) {
      .game-container {
        flex-direction: column;
      }
      
      #gameCanvas {
        width: 100%;
        height: auto;
      }
    }

    /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ */
    .logout-button {
      background: linear-gradient(45deg, #f44336, #e53935);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 10px;
      transition: all 0.3s ease;
    }

    .logout-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    .form-toggle {
      margin-top: 15px;
      font-size: 14px;
      color: #666;
    }

    .form-toggle a {
      color: #667eea;
      text-decoration: none;
      cursor: pointer;
    }

    .form-toggle a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="loginScreen">
    <div class="login-container">
      <h2>ğŸ® ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒˆãƒ«ã‚²ãƒ¼ãƒ </h2>
      
      <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="loginForm" class="login-form">
        <p>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</p>
        
        <input type="email" id="loginEmail" class="login-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
        <input type="password" id="loginPassword" class="login-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
        
        <div>
          <button id="loginButton" class="login-button">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </div>
        
        <div class="form-toggle">
          åˆå›ã®æ–¹ã¯ <a id="showSignupForm">æ–°è¦ç™»éŒ²</a>
        </div>
      </div>

      <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="signupForm" class="signup-form">
        <p>æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</p>
        
        <input type="text" id="signupUsername" class="login-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" required>
        <input type="text" id="signupName" class="login-input" placeholder="è¡¨ç¤ºå" required>
        <input type="email" id="signupEmail" class="login-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
        <input type="password" id="signupPassword" class="login-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰" required>
        
        <div>
          <button id="signupButton" class="login-button signup-button">æ–°è¦ç™»éŒ²</button>
        </div>
        
        <div class="form-toggle">
          æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ <a id="showLoginForm">ãƒ­ã‚°ã‚¤ãƒ³</a>
        </div>
      </div>
      
      <div id="authError" style="color: red; margin-top: 10px; display: none;"></div>
      <div id="authSuccess" style="color: green; margin-top: 10px; display: none;"></div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ -->
  <div id="gameScreen" style="display: none;">
    <h1>ãƒ–ãƒ­ãƒƒã‚¯ã§ä½œã‚‹å¯¾æˆ¦ã‚²ãƒ¼ãƒ </h1>
    
    <div class="game-container">
      <div class="game-area">
        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <!-- HPãƒãƒ¼ -->
        <div>
          <div id="playerHP">Player: 100</div>
          <div id="enemyHP">Enemy: 50</div>
        </div>

        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="profile-area">
          <button id="profileToggle" class="profile-toggle">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º</button>
          
          <div id="profileContent" class="profile-content">
            <div class="profile-item">
              <span class="profile-label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</span>
              <span id="profileName" class="profile-value">-</span>
              <button id="logoutButton" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            
            <div class="profile-item">
              <span class="profile-label">ãƒ¬ãƒ™ãƒ«:</span>
              <span id="profileLevel" class="profile-value">Lv.0</span>
            </div>
            
            <div class="profile-item">
              <span class="profile-label">çµŒé¨“å€¤:</span>
              <span id="profileExp" class="profile-value">0</span>
            </div>
            
            <div class="exp-bar-container">
              <div class="exp-bar-bg">
                <div id="expBar" class="exp-bar"></div>
              </div>
              <small id="expToNext">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§: 100</small>
            </div>
            
            <div class="profile-item">
              <span class="profile-label">ğŸ† ãƒˆãƒ­ãƒ•ã‚£ãƒ¼:</span>
              <span id="profileTrophies" class="profile-value">0</span>
            </div>
            
            <div class="badges-container">
              <div class="profile-label" style="margin-bottom: 5px;">ğŸ–ï¸ ãƒãƒƒã‚¸:</div>
              <div id="profileBadges"></div>
            </div>
          </div>
        </div>
      </div>
        
      <div class="editor-area">
        <!-- ãƒ–ãƒ­ãƒƒã‚¯ã‚¨ãƒ‡ã‚£ã‚¿ -->
        <div id="blocklyDiv"></div>
        <button id="runButton">ğŸš€ å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>
  
  <xml id="toolbox" style="display: none"></xml>

  <!-- JavaScriptéƒ¨åˆ† -->
  <script type="module">
    // æ—¢å­˜ã®Supabaseé–¢æ•°ã‚’import
    import { signIn, signUp, signOut, getProfile, updateExperience, addBadge } from './lib/profile.js';

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†
    class GameLoginManager {
      constructor() {
        this.currentProfile = null;
        this.setupEventListeners();
      }

      setupEventListeners() {
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
        document.getElementById('loginButton').addEventListener('click', () => {
          this.handleLogin();
        });

        // æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³
        document.getElementById('signupButton').addEventListener('click', () => {
          this.handleSignup();
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³
        document.getElementById('logoutButton').addEventListener('click', () => {
          this.handleLogout();
        });

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('profileToggle').addEventListener('click', () => {
          this.toggleProfile();
        });

        // ãƒ•ã‚©ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('showSignupForm').addEventListener('click', () => {
          this.showSignupForm();
        });

        document.getElementById('showLoginForm').addEventListener('click', () => {
          this.showLoginForm();
        });

        // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.handleLogin();
          }
        });

        document.getElementById('signupPassword').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.handleSignup();
          }
        });
      }

      showSignupForm() {
        document.getElementById('loginForm').classList.remove('active');
        document.getElementById('signupForm').classList.add('active');
        this.clearMessages();
      }

      showLoginForm() {
        document.getElementById('signupForm').classList.remove('active');
        document.getElementById('loginForm').classList.add('active');
        this.clearMessages();
      }

      async handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const button = document.getElementById('loginButton');

        if (!email || !password) {
          this.showError('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        try {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
          button.disabled = true;
          button.innerHTML = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­... <div class="loading"></div>';

          // å®Ÿéš›ã®Supabaseèªè¨¼
          const user = await signIn(email, password);
          console.log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', user);

          // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
          this.currentProfile = await getProfile();
          console.log('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—:', this.currentProfile);

          this.showGameScreen();
          this.clearMessages();

        } catch (error) {
          console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
          this.showError('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        } finally {
          button.disabled = false;
          button.innerHTML = 'ãƒ­ã‚°ã‚¤ãƒ³';
        }
      }

      async handleSignup() {
        const username = document.getElementById('signupUsername').value;
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const button = document.getElementById('signupButton');

        if (!username || !name || !email || !password) {
          this.showError('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        if (password.length < 6) {
          this.showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        try {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
          button.disabled = true;
          button.innerHTML = 'ç™»éŒ²ä¸­... <div class="loading"></div>';

          // å®Ÿéš›ã®Supabaseæ–°è¦ç™»éŒ²
          const user = await signUp(email, password, username, name);
          console.log('æ–°è¦ç™»éŒ²æˆåŠŸ:', user);

          this.showSuccess('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚');
          
          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ
          setTimeout(() => {
            this.showLoginForm();
            document.getElementById('loginEmail').value = email;
          }, 2000);

        } catch (error) {
          console.error('æ–°è¦ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
          this.showError('æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        } finally {
          button.disabled = false;
          button.innerHTML = 'æ–°è¦ç™»éŒ²';
        }
      }

      async handleLogout() {
        try {
          await signOut();
          this.currentProfile = null;
          document.getElementById('loginScreen').style.display = 'flex';
          document.getElementById('gameScreen').style.display = 'none';
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
          document.getElementById('loginEmail').value = '';
          document.getElementById('loginPassword').value = '';
          document.getElementById('signupUsername').value = '';
          document.getElementById('signupName').value = '';
          document.getElementById('signupEmail').value = '';
          document.getElementById('signupPassword').value = '';
          
          this.showLoginForm();
          this.clearMessages();
          
        } catch (error) {
          console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      showGameScreen() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'block';
        this.updateProfileDisplay();
      }

      showError(message) {
        const errorDiv = document.getElementById('authError');
        const successDiv = document.getElementById('authSuccess');
        successDiv.style.display = 'none';
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }

      showSuccess(message) {
        const errorDiv = document.getElementById('authError');
        const successDiv = document.getElementById('authSuccess');
        errorDiv.style.display = 'none';
        successDiv.textContent = message;
        successDiv.style.display = 'block';
      }

      clearMessages() {
        document.getElementById('authError').style.display = 'none';
        document.getElementById('authSuccess').style.display = 'none';
      }

      toggleProfile() {
        const content = document.getElementById('profileContent');
        const button = document.getElementById('profileToggle');
        
        if (content.classList.contains('visible')) {
          content.classList.remove('visible');
          button.textContent = 'ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º';
        } else {
          content.classList.add('visible');
          button.textContent = 'ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«éè¡¨ç¤º';
          this.updateProfileDisplay();
        }
      }

      updateProfileDisplay() {
        if (!this.currentProfile) return;

        const currentLevel = Math.floor(this.currentProfile.experience_points / 100);
        const currentLevelExp = this.currentProfile.experience_points - (currentLevel * 100);
        const expToNext = 100 - currentLevelExp;
        const expPercentage = (currentLevelExp / 100) * 100;

        document.getElementById('profileName').textContent = this.currentProfile.name;
        document.getElementById('profileLevel').textContent = `Lv.${currentLevel}`;
        document.getElementById('profileExp').textContent = this.currentProfile.experience_points;
        document.getElementById('profileTrophies').textContent = this.currentProfile.trophy_count;
        document.getElementById('expToNext').textContent = `æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§: ${expToNext}`;
        document.getElementById('expBar').style.width = `${expPercentage}%`;

        // ãƒãƒƒã‚¸è¡¨ç¤º
        const badgesContainer = document.getElementById('profileBadges');
        badgesContainer.innerHTML = '';
        if (this.currentProfile.badges && this.currentProfile.badges.length > 0) {
          this.currentProfile.badges.forEach(badge => {
            const badgeElement = document.createElement('span');
            badgeElement.className = 'badge';
            badgeElement.textContent = badge;
            badgesContainer.appendChild(badgeElement);
          });
        } else {
          badgesContainer.innerHTML = '<span style="color: #999; font-size: 12px;">ã¾ã ãƒãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</span>';
        }
      }

      // ãƒãƒˆãƒ«å‹åˆ©æ™‚ã®çµŒé¨“å€¤è¿½åŠ 
      async addExperience(points) {
        if (!this.currentProfile) return;

        try {
          const oldLevel = Math.floor(this.currentProfile.experience_points / 100);
          const newExpPoints = this.currentProfile.experience_points + points;
          
          // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
          const updatedProfile = await updateExperience(newExpPoints);
          
          if (updatedProfile && updatedProfile.length > 0) {
            this.currentProfile = updatedProfile[0];
            
            const newLevel = Math.floor(this.currentProfile.experience_points / 100);

            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†
            if (newLevel > oldLevel) {
              await this.handleLevelUp(newLevel);
              this.showLevelUpEffect(newLevel);
            }

            this.updateProfileDisplay();
            return { levelUp: newLevel > oldLevel, newLevel, earnedExp: points };
          }
        } catch (error) {
          console.error('çµŒé¨“å€¤æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      async handleLevelUp(newLevel) {
        try {
          // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒãƒƒã‚¸
          const levelBadges = {
            5: 'ãƒ¬ãƒ™ãƒ«5é”æˆ',
            10: 'ãƒ¬ãƒ™ãƒ«10é”æˆ',
            20: 'ãƒ¬ãƒ™ãƒ«20é”æˆ',
            50: 'ãƒ¬ãƒ™ãƒ«50é”æˆ'
          };

          if (levelBadges[newLevel]) {
            const updatedProfile = await addBadge(levelBadges[newLevel]);
            if (updatedProfile && updatedProfile.length > 0) {
              this.currentProfile = updatedProfile[0];
            }
          }
        } catch (error) {
          console.error('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒãƒƒã‚¸è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
        }
      }

      showLevelUpEffect(newLevel) {
        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        const popup = document.createElement('div');
        popup.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: linear-gradient(45deg, #FFD700, #FFA500);
          color: #333;
          padding: 30px;
          border-radius: 15px;
          font-size: 24px;
          font-weight: bold;
          text-align: center;
          z-index: 2000;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          animation: levelUpPulse 2s ease-in-out;
        `;
        popup.innerHTML = `ğŸ‰<br>LEVEL UP!<br>Lv.${newLevel}`;

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ CSS ã‚’è¿½åŠ 
        const style = document.createElement('style');
        style.textContent = `
          @keyframes levelUpPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
          }
        `;
        document.head.appendChild(style);

        document.body.appendChild(popup);

        setTimeout(() => {
          document.body.removeChild(popup);
          document.head.removeChild(style);
        }, 2000);
      }
    }

    // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
    window.gameLoginManager = new GameLoginManager();

    // æ—¢å­˜ã®index.jsã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼‰
    window.addGameExperience = (points) => {
      return window.gameLoginManager.addExperience(points);
    };

    // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢æ™‚ã®ãƒãƒƒã‚¸è¿½åŠ é–¢æ•°ã‚‚å…¬é–‹
    window.addStageBadge = async (stageName) => {
      if (window.gameLoginManager.currentProfile) {
        try {
          const badgeName = `${stageName}åˆå›ã‚¯ãƒªã‚¢`;
          const updatedProfile = await addBadge(badgeName);
          if (updatedProfile && updatedProfile.length > 0) {
            window.gameLoginManager.currentProfile = updatedProfile[0];
            window.gameLoginManager.updateProfileDisplay();
          }
        } catch (error) {
          console.error('ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒƒã‚¸è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
        }
      }
    };
  </script>
</body>
</html>