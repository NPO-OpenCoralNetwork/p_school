<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数字カードバトル - ローカルマルチプレイ版</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .setup-section {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .input-group input {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            margin: 5px;
            width: 250px;
        }

        .btn {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .room-code {
            font-size: 2em;
            color: #FFD700;
            background: rgba(255,255,255,0.2);
            padding: 15px 30px;
            border-radius: 15px;
            margin: 20px 0;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .info-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .info-card h3 {
            margin-top: 0;
            color: #FFD700;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .player-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 3px solid transparent;
        }

        .player-card.current-user {
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }

        .player-card.ready {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .player-score {
            font-size: 1.1em;
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .player-status {
            font-size: 0.9em;
            margin-bottom: 10px;
            padding: 5px 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }

        .hand {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
        }

        .card {
            width: 50px;
            height: 70px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            color: #333;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .card:hover:not(.disabled) {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
        }

        .card.selected {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            transform: translateY(-5px) scale(1.1);
            border-color: #FF6B35;
        }

        .card.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .submitted-card {
            width: 80px;
            height: 110px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: 3px solid #2E7D32;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            margin: 10px auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .submitted-card.winner {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-color: #FF6B35;
            animation: winner-glow 2s ease-in-out;
        }

        @keyframes winner-glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6); }
        }

        .round-results {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .result-item {
            text-align: center;
        }

        .result-card {
            width: 60px;
            height: 80px;
            margin: 0 auto 10px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            color: #333;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .result-card.rank-1 {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-color: #FF6B35;
        }

        .result-card.rank-2 {
            background: linear-gradient(45deg, #C0C0C0, #A0A0A0);
            border-color: #808080;
        }

        .result-card.rank-3 {
            background: linear-gradient(45deg, #CD7F32, #B8860B);
            border-color: #8B4513;
        }

        .status {
            font-size: 1.5em;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .final-results {
            background: rgba(255,255,255,0.15);
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(255,215,0,0.3);
        }

        .winner-announcement {
            font-size: 2.5em;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: winner-text 2s ease-in-out infinite;
        }

        @keyframes winner-text {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }

        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .instructions h3 {
            color: #FFD700;
            margin-top: 0;
        }

        .instructions ol {
            line-height: 1.8;
        }

        @media (max-width: 768px) {
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            .hand {
                gap: 5px;
            }
            
            .card {
                width: 40px;
                height: 55px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🃏 数字カードバトル - ローカルマルチプレイ版</h1>
        
        <!-- 接続状況表示 -->
        <div class="connection-status">
            ローカル接続
        </div>

        <!-- ルーム作成・参加画面 -->
        <div id="roomSelection" class="setup-section">
            <h2>ルーム作成・参加</h2>
            
            <div class="instructions">
                <h3>📱 複数人プレイの方法</h3>
                <ol>
                    <li><strong>ホスト（1人目）</strong>：「新しいルーム作成」をクリック</li>
                    <li><strong>他のプレイヤー</strong>：新しいタブを開いてこのページにアクセス</li>
                    <li>表示されたルームコードを入力して参加</li>
                    <li>全員揃ったらホストがゲーム開始</li>
                </ol>
                <p><strong>💡 ヒント：</strong> 同じブラウザで複数タブを開いて1人で複数プレイヤーをテストすることもできます！</p>
            </div>
            
            <div class="input-group">
                <label for="playerName">プレイヤー名:</label>
                <input type="text" id="playerName" placeholder="あなたの名前" maxlength="20">
            </div>
            
            <div style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
                <button class="btn btn-primary" onclick="createRoom()">新しいルーム作成</button>
            </div>
            
            <div class="input-group">
                <label for="roomCode">ルームコード:</label>
                <input type="text" id="roomCode" placeholder="ルームコードを入力" maxlength="6">
                <button class="btn btn-secondary" onclick="joinRoom()">参加</button>
            </div>
            
            <div id="errorMessage" class="error-message hidden"></div>
        </div>

        <!-- 待機画面 -->
        <div id="waitingRoom" class="setup-section hidden">
            <h2>ルーム待機中</h2>
            <div id="roomCodeDisplay" class="room-code"></div>
            <div id="waitingPlayers" class="players-grid"></div>
            <div id="waitingStatus" class="status">プレイヤーを待っています...</div>
            <div style="margin: 20px 0;">
                <button id="startGameBtn" class="btn btn-primary hidden" onclick="startGame()">ゲーム開始</button>
                <button class="btn btn-secondary" onclick="leaveRoom()">ルームを出る</button>
            </div>
        </div>

        <!-- ゲーム画面 -->
        <div id="gameScreen" class="hidden">
            <!-- ゲーム情報 -->
            <div class="game-info">
                <div class="info-card">
                    <h3>現在のラウンド</h3>
                    <div id="currentRound" style="font-size: 2em;">1</div>
                </div>
                <div class="info-card">
                    <h3>今回のポイント</h3>
                    <div id="currentPoints" style="font-size: 2em; color: #FFD700;">1</div>
                </div>
                <div class="info-card">
                    <h3>提出済み</h3>
                    <div id="submittedCount" style="font-size: 2em;">0</div>
                </div>
            </div>

            <!-- ステータス -->
            <div id="gameStatus" class="status">カードを選んで提出してください</div>

            <!-- プレイヤー表示 -->
            <div id="playersGrid" class="players-grid"></div>

            <!-- ラウンド結果 -->
            <div id="roundResults" class="round-results hidden">
                <h3>ラウンド結果</h3>
                <div id="resultsGrid" class="results-grid"></div>
                <button id="nextRoundBtn" class="btn btn-primary hidden" onclick="nextRound()">次のラウンド</button>
            </div>

            <!-- 最終結果 -->
            <div id="finalResults" class="final-results hidden">
                <div id="winnerAnnouncement" class="winner-announcement"></div>
                <div id="finalScores"></div>
                <button class="btn btn-secondary" onclick="leaveRoom()">新しいゲーム</button>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-secondary" onclick="leaveRoom()">ルームを出る</button>
            </div>
        </div>
    </div>

    <script>
        // ローカルストレージをゲーム状態管理に使用
        let currentUserId = null;
        let currentRoom = null;
        let currentPlayer = null;
        let players = [];
        let gameState = null;
        let isHost = false;
        let updateInterval = null;

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
            
            // 既存のルーム情報を確認
            const existingRoom = localStorage.getItem('currentRoom');
            if (existingRoom) {
                try {
                    currentRoom = JSON.parse(existingRoom);
                    const playerName = localStorage.getItem('currentPlayerName');
                    if (playerName) {
                        document.getElementById('playerName').value = playerName;
                        rejoinRoom();
                    }
                } catch (e) {
                    // エラーの場合は無視
                    localStorage.removeItem('currentRoom');
                }
            }
            
            // 選択状態を復元
            const savedSelectedCard = sessionStorage.getItem('selectedCard');
            if (savedSelectedCard) {
                // ページ再読み込み後も選択状態を維持
                setTimeout(() => {
                    if (currentPlayer && !currentPlayer.submittedCard) {
                        currentPlayer.selectedCard = parseInt(savedSelectedCard);
                        updatePlayersDisplay();
                    }
                }, 1000);
            }
        });

        // エラー表示
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // ルーム作成
        function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showError('プレイヤー名を入力してください');
                return;
            }
            
            const roomCode = generateRoomCode();
            
            currentRoom = {
                code: roomCode,
                status: 'waiting',
                round: 1,
                points: 1,
                phase: 'waiting',
                createdAt: Date.now()
            };
            
            currentPlayer = {
                id: currentUserId,
                name: playerName,
                score: 0,
                hand: [1,2,3,4,5,6,7,8,9,10],
                selectedCard: null,
                submittedCard: null,
                isHost: true
            };
            
            isHost = true;
            
            // ローカルストレージに保存
            localStorage.setItem('currentRoom', JSON.stringify(currentRoom));
            localStorage.setItem('currentPlayerName', playerName);
            localStorage.setItem(`room_${roomCode}`, JSON.stringify(currentRoom));
            localStorage.setItem(`room_${roomCode}_players`, JSON.stringify([currentPlayer]));
            
            enterWaitingRoom();
        }

        // ルームコード生成
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // ルーム参加
        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!roomCode) {
                showError('ルームコードを入力してください');
                return;
            }
            
            if (!playerName) {
                showError('プレイヤー名を入力してください');
                return;
            }
            
            // ルーム存在確認
            const roomData = localStorage.getItem(`room_${roomCode}`);
            if (!roomData) {
                showError('ルームが見つかりません');
                return;
            }
            
            try {
                currentRoom = JSON.parse(roomData);
                
                // プレイヤー一覧取得
                const playersData = localStorage.getItem(`room_${roomCode}_players`);
                const existingPlayers = playersData ? JSON.parse(playersData) : [];
                
                // 同名プレイヤーチェック
                if (existingPlayers.some(p => p.name === playerName)) {
                    showError('同じ名前のプレイヤーが既に存在します');
                    return;
                }
                
                // 人数制限チェック
                if (existingPlayers.length >= 8) {
                    showError('ルームが満員です');
                    return;
                }
                
                currentPlayer = {
                    id: currentUserId,
                    name: playerName,
                    score: 0,
                    hand: [1,2,3,4,5,6,7,8,9,10],
                    selectedCard: null,
                    submittedCard: null,
                    isHost: false
                };
                
                isHost = false;
                
                // プレイヤーを追加
                existingPlayers.push(currentPlayer);
                localStorage.setItem(`room_${roomCode}_players`, JSON.stringify(existingPlayers));
                localStorage.setItem('currentRoom', JSON.stringify(currentRoom));
                localStorage.setItem('currentPlayerName', playerName);
                
                if (currentRoom.status === 'waiting') {
                    enterWaitingRoom();
                } else {
                    enterGameRoom();
                }
                
            } catch (error) {
                console.error('ルーム参加エラー:', error);
                showError('ルーム参加に失敗しました');
            }
        }

        // ルーム再参加
        function rejoinRoom() {
            if (!currentRoom) return;
            
            // プレイヤー情報復元
            const playersData = localStorage.getItem(`room_${currentRoom.code}_players`);
            if (playersData) {
                const existingPlayers = JSON.parse(playersData);
                const player = existingPlayers.find(p => p.id === currentUserId);
                if (player) {
                    currentPlayer = player;
                    isHost = player.isHost;
                    
                    if (currentRoom.status === 'waiting') {
                        enterWaitingRoom();
                    } else {
                        enterGameRoom();
                    }
                }
            }
        }

        // 待機ルーム入室
        function enterWaitingRoom() {
            document.getElementById('roomSelection').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            
            document.getElementById('roomCodeDisplay').textContent = `ルームコード: ${currentRoom.code}`;
            
            // 定期更新開始
            startUpdates();
            updateWaitingRoom();
        }

        // ゲームルーム入室
        function enterGameRoom() {
            document.getElementById('roomSelection').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // 定期更新開始
            startUpdates();
            loadGameState();
            updateGameDisplay();
        }

        // 定期更新開始
        function startUpdates() {
            if (updateInterval) clearInterval(updateInterval);
            
            updateInterval = setInterval(() => {
                if (currentRoom) {
                    const oldStatus = currentRoom.status;
                    const oldPhase = gameState ? gameState.phase : null;
                    
                    loadPlayers();
                    loadGameState();
                    
                    // ゲーム状態変化チェック
                    if (oldStatus === 'waiting' && currentRoom.status === 'playing') {
                        // ゲーム開始された
                        if (!document.getElementById('gameScreen').classList.contains('hidden')) {
                            updateGameDisplay();
                        } else {
                            enterGameRoom();
                        }
                    }
                    
                    // フェーズ変化チェック（results → playing）
                    if (oldPhase === 'results' && gameState.phase === 'playing') {
                        console.log('🔄 新しいラウンド開始 - 結果画面を非表示にします');
                        document.getElementById('roundResults').classList.add('hidden');
                        document.getElementById('nextRoundBtn').classList.add('hidden');
                    }
                    
                    if (!document.getElementById('waitingRoom').classList.contains('hidden')) {
                        updateWaitingRoom();
                    } else if (!document.getElementById('gameScreen').classList.contains('hidden')) {
                        updateGameDisplay();
                        
                        // 結果フェーズの処理
                        if (gameState && gameState.phase === 'results' && currentRoom.lastResults) {
                            if (document.getElementById('roundResults').classList.contains('hidden')) {
                                showRoundResults(currentRoom.lastResults, true);
                            }
                        }
                        
                        // ゲーム終了フェーズの処理
                        if (gameState && gameState.phase === 'finished') {
                            console.log('🏁 ゲーム終了フェーズ検出。ホスト:', isHost);
                            if (document.getElementById('finalResults').classList.contains('hidden')) {
                                console.log('💡 最終結果画面を表示します');
                                endGame();
                            } else {
                                console.log('ℹ️ 最終結果画面は既に表示済み');
                            }
                        }
                    }
                }
            }, 500); // 更新頻度を上げる
        }

        // 定期更新停止
        function stopUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // プレイヤー一覧読み込み
        function loadPlayers() {
            if (!currentRoom) return;
            
            const playersData = localStorage.getItem(`room_${currentRoom.code}_players`);
            if (playersData) {
                const loadedPlayers = JSON.parse(playersData);
                
                // 現在のプレイヤーの提出済み状態を確認
                const currentInLoaded = loadedPlayers.find(p => p.id === currentUserId);
                const hasSubmitted = currentPlayer && currentPlayer.submittedCard !== null;
                
                players = loadedPlayers;
                
                // 現在のプレイヤー情報更新
                const updated = players.find(p => p.id === currentUserId);
                if (updated) {
                    // 提出済みの場合は選択状態をクリア
                    if (updated.submittedCard !== null) {
                        sessionStorage.removeItem('selectedCard');
                        currentPlayer = updated;
                    } else {
                        // 未提出の場合のみ選択状態を保持
                        const savedSelectedCard = sessionStorage.getItem('selectedCard');
                        currentPlayer = updated;
                        if (savedSelectedCard && !hasSubmitted) {
                            currentPlayer.selectedCard = parseInt(savedSelectedCard);
                        }
                    }
                }
            }
        }

        // ゲーム状態読み込み
        function loadGameState() {
            if (!currentRoom) return;
            
            const roomData = localStorage.getItem(`room_${currentRoom.code}`);
            if (roomData) {
                const room = JSON.parse(roomData);
                currentRoom = room;
                gameState = {
                    round: room.round || 1,
                    points: room.points || 1,
                    phase: room.phase || 'waiting'
                };
            }
        }

        // 待機ルーム表示更新
        function updateWaitingRoom() {
            if (document.getElementById('waitingRoom').classList.contains('hidden')) return;
            
            loadPlayers();
            loadGameState();
            
            // ゲーム開始チェック
            if (currentRoom && currentRoom.status === 'playing') {
                enterGameRoom();
                return;
            }
            
            const waitingPlayers = document.getElementById('waitingPlayers');
            waitingPlayers.innerHTML = '';
            
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                if (player.id === currentUserId) {
                    playerCard.classList.add('current-user');
                }
                
                let hostBadge = player.isHost ? ' 👑' : '';
                
                playerCard.innerHTML = `
                    <div class="player-name">${player.name}${hostBadge}</div>
                    <div class="player-status">待機中</div>
                `;
                
                waitingPlayers.appendChild(playerCard);
            });
            
            // ホストならゲーム開始ボタン表示
            const hasEnoughPlayers = players.length >= 2;
            
            if (isHost && hasEnoughPlayers) {
                document.getElementById('startGameBtn').classList.remove('hidden');
            } else {
                document.getElementById('startGameBtn').classList.add('hidden');
            }
            
            // 状態メッセージ
            const waitingStatus = document.getElementById('waitingStatus');
            if (players.length < 2) {
                waitingStatus.textContent = `プレイヤーを待っています... (${players.length}/2人以上)`;
            } else if (isHost) {
                waitingStatus.textContent = 'ゲーム開始の準備ができました！';
            } else {
                waitingStatus.textContent = 'ホストのゲーム開始を待っています...';
            }
        }

        // ゲーム開始
        function startGame() {
            if (!isHost) {
                showError('ホストのみがゲームを開始できます');
                return;
            }
            
            currentRoom.status = 'playing';
            currentRoom.phase = 'playing';
            
            localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
            
            enterGameRoom();
        }

        // ゲーム画面表示更新
        function updateGameDisplay() {
            if (document.getElementById('gameScreen').classList.contains('hidden')) return;
            
            loadPlayers();
            loadGameState();
            
            // ゲーム情報更新
            document.getElementById('currentRound').textContent = gameState?.round || 1;
            document.getElementById('currentPoints').textContent = gameState?.points || 1;
            
            // 提出済み数
            const submittedCount = players.filter(p => p.submittedCard !== null).length;
            document.getElementById('submittedCount').textContent = `${submittedCount}/${players.length}`;
            
            // プレイヤー表示
            updatePlayersDisplay();
            
            // ステータス更新
            updateGameStatus();
            
            // 結果表示チェック
            if (gameState && gameState.phase === 'results' && currentRoom.lastResults) {
                if (document.getElementById('roundResults').classList.contains('hidden')) {
                    showRoundResults(currentRoom.lastResults, true);
                }
            }
            
            // 全員提出チェック（ホストのみ）
            if (isHost && submittedCount === players.length && submittedCount > 0 && gameState.phase === 'playing') {
                const allSubmitted = players.every(p => p.submittedCard !== null);
                if (allSubmitted) {
                    setTimeout(() => resolveRound(), 1000);
                }
            }
        }

        // プレイヤー表示更新
        function updatePlayersDisplay() {
            const playersGrid = document.getElementById('playersGrid');
            playersGrid.innerHTML = '';
            
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                if (player.id === currentUserId) {
                    playerCard.classList.add('current-user');
                }
                
                if (player.submittedCard !== null) {
                    playerCard.classList.add('ready');
                }
                
                const playerName = document.createElement('div');
                playerName.className = 'player-name';
                playerName.textContent = player.name;
                
                const playerScore = document.createElement('div');
                playerScore.className = 'player-score';
                playerScore.textContent = `スコア: ${player.score}`;
                
                const hand = document.createElement('div');
                hand.className = 'hand';
                
                // 手札表示（自分のみ詳細表示）
                if (player.id === currentUserId) {
                    const handArray = player.hand || [1,2,3,4,5,6,7,8,9,10];
                    
                    handArray.forEach(cardValue => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.textContent = cardValue;
                        
                        if (player.selectedCard === cardValue) {
                            card.classList.add('selected');
                        }
                        
                        if (player.submittedCard !== null) {
                            card.classList.add('disabled');
                        } else if (gameState && gameState.phase === 'playing') {
                            card.onclick = () => selectCard(cardValue);
                        } else {
                            card.classList.add('disabled');
                        }
                        
                        hand.appendChild(card);
                    });
                    
                    // 確定・キャンセルボタンを追加
                    if (player.submittedCard === null && gameState && gameState.phase === 'playing') {
                        const buttonContainer = document.createElement('div');
                        buttonContainer.style.cssText = 'margin-top: 15px; display: flex; gap: 10px; justify-content: center;';
                        
                        if (player.selectedCard !== null) {
                            const confirmBtn = document.createElement('button');
                            confirmBtn.className = 'btn btn-primary';
                            confirmBtn.style.cssText = 'padding: 8px 16px; font-size: 14px;';
                            confirmBtn.textContent = `${player.selectedCard}を確定`;
                            confirmBtn.onclick = confirmCard;
                            
                            const cancelBtn = document.createElement('button');
                            cancelBtn.className = 'btn btn-secondary';
                            cancelBtn.style.cssText = 'padding: 8px 16px; font-size: 14px;';
                            cancelBtn.textContent = 'キャンセル';
                            cancelBtn.onclick = cancelCardSelection;
                            
                            buttonContainer.appendChild(confirmBtn);
                            buttonContainer.appendChild(cancelBtn);
                        } else {
                            const selectMsg = document.createElement('div');
                            selectMsg.style.cssText = 'color: #FFD700; font-size: 14px; padding: 8px;';
                            selectMsg.textContent = 'カードを選択してください';
                            buttonContainer.appendChild(selectMsg);
                        }
                        
                        hand.appendChild(buttonContainer);
                    }
                    
                } else {
                    // 他のプレイヤーの手札（カード数のみ表示）
                    const handArray = player.hand || [];
                    const cardCount = handArray.length;
                    
                    for (let i = 0; i < cardCount; i++) {
                        const card = document.createElement('div');
                        card.className = 'card disabled';
                        card.textContent = '?';
                        hand.appendChild(card);
                    }
                }
                
                // 提出済みカード表示
                if (player.submittedCard !== null) {
                    const submittedCard = document.createElement('div');
                    submittedCard.className = 'submitted-card';
                    submittedCard.textContent = player.submittedCard;
                    hand.appendChild(submittedCard);
                }
                
                playerCard.appendChild(playerName);
                playerCard.appendChild(playerScore);
                playerCard.appendChild(hand);
                playersGrid.appendChild(playerCard);
            });
        }

        // ゲームステータス更新
        function updateGameStatus() {
            const status = document.getElementById('gameStatus');
            
            const submittedCount = players.filter(p => p.submittedCard !== null).length;
            const totalPlayers = players.length;
            
            if (currentPlayer && currentPlayer.submittedCard !== null) {
                status.textContent = `カードを提出しました。他のプレイヤーを待っています... (${submittedCount}/${totalPlayers})`;
            } else if (submittedCount === 0) {
                status.textContent = 'カードを選んで提出してください';
            } else {
                status.textContent = `${totalPlayers - submittedCount}人の提出を待っています...`;
            }
        }

        // カード選択
        function selectCard(cardValue) {
            if (!currentPlayer || currentPlayer.submittedCard !== null) return;
            
            console.log('カード選択:', cardValue); // デバッグ用
            
            // 選択状態を更新（まだ提出はしない）
            currentPlayer.selectedCard = cardValue;
            
            // 選択状態をローカルに一時保存（定期更新で消えないように）
            sessionStorage.setItem('selectedCard', cardValue);
            
            // 画面を即座に更新（選択状態を表示）
            updatePlayersDisplay();
        }

        // カード確定・提出
        function confirmCard() {
            if (!currentPlayer || !currentPlayer.selectedCard || currentPlayer.submittedCard !== null) return;
            
            console.log('🎴 カード確定処理開始');
            console.log('選択カード:', currentPlayer.selectedCard);
            console.log('プレイヤー名:', currentPlayer.name);
            
            const cardToSubmit = currentPlayer.selectedCard;
            
            // 手札から削除
            currentPlayer.hand = currentPlayer.hand.filter(card => card !== cardToSubmit);
            currentPlayer.submittedCard = cardToSubmit;
            currentPlayer.selectedCard = null;
            
            // 選択状態をクリア
            sessionStorage.removeItem('selectedCard');
            
            // 他のプレイヤーのデータを取得
            const playersData = localStorage.getItem(`room_${currentRoom.code}_players`);
            let allPlayers = playersData ? JSON.parse(playersData) : [];
            
            // 現在のプレイヤーのデータを更新
            allPlayers = allPlayers.map(p => 
                p.id === currentUserId ? { ...currentPlayer } : p
            );
            
            // データを保存
            localStorage.setItem(`room_${currentRoom.code}_players`, JSON.stringify(allPlayers));
            
            console.log('✅ 提出完了');
            console.log('残り手札:', currentPlayer.hand);
            console.log('提出カード:', currentPlayer.submittedCard);
            console.log('更新後の全プレイヤー:', allPlayers.map(p => `${p.name}:${p.submittedCard || '未提出'}`));
            
            // 手札チェック（10ラウンド後で手札が空の場合）
            if (currentPlayer.hand.length === 0) {
                console.log('🎯 手札が空になりました');
                loadGameState();
                if (gameState && gameState.round >= 10) {
                    console.log('🏁 10ラウンド後に手札が空 - ゲーム終了を検出');
                    setTimeout(() => {
                        console.log('💡 参加者による強制ゲーム終了処理');
                        endGame();
                    }, 3000);
                }
            }
            
            // 画面更新（loadPlayersを呼ばずに直接更新）
            updatePlayersDisplay();
            updateGameStatus();
            
            // 強制的にゲーム状態をチェック
            setTimeout(() => {
                console.log('⏰ 提出後の状態チェック');
                updateGameDisplay();
            }, 500);
        }

        // カード選択キャンセル
        function cancelCardSelection() {
            if (!currentPlayer || currentPlayer.submittedCard !== null) return;
            
            currentPlayer.selectedCard = null;
            sessionStorage.removeItem('selectedCard');
            updatePlayersDisplay();
        }

        // ラウンド結果処理
        function resolveRound() {
            if (!isHost) return;
            
            // 既に処理中の場合はスキップ
            if (currentRoom.phase !== 'playing') {
                console.log('⚠️ 既に結果処理済み、スキップします。現在フェーズ:', currentRoom.phase);
                return;
            }
            
            console.log('🎯 ラウンド結果処理開始');
            
            // 即座にフェーズを変更して重複実行を防ぐ
            currentRoom.phase = 'resolving';
            localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
            
            loadPlayers();
            
            const submittedCards = players.map(p => ({
                player: p,
                card: p.submittedCard
            }));
            
            console.log('提出されたカード:', submittedCards.map(c => `${c.player.name}:${c.card}`));
            
            // null値チェック
            const hasNullCards = submittedCards.some(c => c.card === null || c.card === undefined);
            if (hasNullCards) {
                console.log('❌ 提出カードにnullが含まれています。処理を中止します。');
                currentRoom.phase = 'playing';
                localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
                return;
            }
            
            // 順位決定
            const rankings = calculateRankings(submittedCards);
            console.log('計算された順位:', rankings);
            
            // ポイント配布
            let pointAwarded = false;
            let newPoints = gameState.points;
            
            if (rankings.length > 0 && rankings[0].rank !== 'tie') {
                // 1位の人がいる場合
                const winner = rankings[0].players[0];
                console.log('勝者:', winner.player.name, '獲得ポイント:', newPoints);
                
                // 勝者のスコアを更新
                const winnerIndex = players.findIndex(p => p.id === winner.player.id);
                if (winnerIndex !== -1) {
                    players[winnerIndex].score += newPoints;
                }
                
                pointAwarded = true;
                newPoints = 1; // 次のラウンドは1ポイントに戻る
            } else {
                // 全員同じの場合、ポイント繰り越し
                newPoints++;
                console.log('引き分け、次回ポイント:', newPoints);
            }
            
            // 提出カードリセット
            players.forEach(player => {
                player.submittedCard = null;
                player.selectedCard = null;
            });
            
            // ゲーム状態更新
            const newRound = gameState.round + 1;
            const gameFinished = newRound > 10; // 11ラウンド目になったら終了
            
            console.log('現在ラウンド:', gameState.round, '次のラウンド:', newRound, 'ゲーム終了:', gameFinished);
            
            currentRoom.round = newRound; // 常に次のラウンドに進める
            currentRoom.points = newPoints;
            currentRoom.phase = gameFinished ? 'finished' : 'results';
            currentRoom.lastResults = rankings;
            
            // 保存
            localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
            localStorage.setItem(`room_${currentRoom.code}_players`, JSON.stringify(players));
            
            // ゲーム状態を更新
            gameState = {
                round: currentRoom.round,
                points: currentRoom.points,
                phase: currentRoom.phase
            };
            
            console.log('✅ ラウンド結果処理完了。新しいフェーズ:', currentRoom.phase);
            
            // 結果表示
            showRoundResults(rankings, pointAwarded);
            
            // ゲーム終了チェック
            if (gameFinished) {
                console.log('🏁 ゲーム終了条件達成。3秒後に終了処理開始');
                setTimeout(() => {
                    console.log('🏁 ゲーム終了処理を実行');
                    endGame();
                }, 3000);
            }
        }

        // 順位計算
        function calculateRankings(submittedCards) {
            console.log('順位計算開始。提出カード:', submittedCards); // デバッグ用
            
            // カードの値で降順ソート
            const sortedCards = [...submittedCards].sort((a, b) => b.card - a.card);
            console.log('ソート後:', sortedCards.map(c => `${c.player.name}:${c.card}`)); // デバッグ用
            
            const rankings = [];
            let currentRank = 1;
            let i = 0;
            
            while (i < sortedCards.length) {
                const currentValue = sortedCards[i].card;
                const sameValuePlayers = sortedCards.filter(item => item.card === currentValue);
                
                console.log(`値${currentValue}の同率プレイヤー:`, sameValuePlayers.length, '人'); // デバッグ用
                
                if (sameValuePlayers.length === sortedCards.length) {
                    // 全員同じ値の場合
                    console.log('全員同じ値 - 引き分け'); // デバッグ用
                    rankings.push({
                        rank: 'tie',
                        players: sameValuePlayers,
                        value: currentValue
                    });
                    break;
                } else if (sameValuePlayers.length === 1) {
                    // 単独順位の場合
                    console.log(`${currentRank}位: ${sameValuePlayers[0].player.name} (${currentValue})`); // デバッグ用
                    rankings.push({
                        rank: currentRank,
                        players: sameValuePlayers,
                        value: currentValue
                    });
                    currentRank++;
                    i++;
                } else {
                    // 同順位が複数いる場合、次の順位の人を探す
                    console.log(`${currentValue}で${sameValuePlayers.length}人が同率 - 次の順位を探す`); // デバッグ用
                    i += sameValuePlayers.length;
                    if (i < sortedCards.length) {
                        currentRank = i + 1;
                        continue;
                    } else {
                        // これ以上の順位がない場合は終了
                        break;
                    }
                }
            }
            
            console.log('最終順位:', rankings); // デバッグ用
            return rankings;
        }

        // ラウンド結果表示
        function showRoundResults(rankings, pointAwarded) {
            console.log('🎊 結果表示開始。ホスト:', isHost);
            console.log('表示する順位:', rankings);
            console.log('現在のゲーム状態:', gameState);
            
            const roundResults = document.getElementById('roundResults');
            const resultsGrid = document.getElementById('resultsGrid');
            
            if (!roundResults || !resultsGrid) {
                console.error('❌ 結果表示要素が見つかりません');
                return;
            }
            
            resultsGrid.innerHTML = '';
            
            rankings.forEach((ranking, index) => {
                console.log(`順位 ${ranking.rank}: ${ranking.players.length}人`);
                ranking.players.forEach(playerData => {
                    console.log(`  - ${playerData.player.name}: ${playerData.card}`);
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';
                    resultCard.textContent = playerData.card;
                    
                    if (ranking.rank === 1) {
                        resultCard.classList.add('rank-1');
                    } else if (ranking.rank === 2) {
                        resultCard.classList.add('rank-2');
                    } else if (ranking.rank === 3) {
                        resultCard.classList.add('rank-3');
                    }
                    
                    const playerName = document.createElement('div');
                    playerName.textContent = playerData.player.name;
                    
                    const rankText = document.createElement('div');
                    if (ranking.rank === 'tie') {
                        rankText.textContent = '引き分け';
                        rankText.style.color = '#FFA500';
                    } else if (ranking.rank === 1 && pointAwarded) {
                        // 獲得ポイントを正確に表示
                        const actualPoints = gameState?.points || currentRoom?.points || 1;
                        rankText.textContent = `${actualPoints}ポイント獲得！`;
                        rankText.style.color = '#4CAF50';
                    } else {
                        rankText.textContent = `${ranking.rank}位`;
                    }
                    
                    resultItem.appendChild(resultCard);
                    resultItem.appendChild(playerName);
                    resultItem.appendChild(rankText);
                    resultsGrid.appendChild(resultItem);
                });
            });
            
            console.log('結果グリッドに追加された要素数:', resultsGrid.children.length);
            
            // 結果画面を表示
            roundResults.classList.remove('hidden');
            console.log('✅ 結果画面を表示しました');
            
            // ホストなら次のラウンドボタン表示
            if (isHost) {
                console.log('ホストなので次ラウンドボタンを表示。現在ラウンド:', currentRoom.round);
                if (currentRoom.round > 10) { // 10ラウンド完了後
                    console.log('10ラウンド完了 - 3秒後にゲーム終了');
                    setTimeout(() => {
                        console.log('🏁 ホストによるゲーム終了処理実行');
                        // ゲーム状態を確実にfinishedに設定
                        currentRoom.phase = 'finished';
                        gameState.phase = 'finished';
                        localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
                        console.log('✅ ゲーム状態をfinishedに設定完了');
                        endGame();
                    }, 3000);
                } else {
                    document.getElementById('nextRoundBtn').classList.remove('hidden');
                    console.log('次ラウンドボタンを表示');
                }
            } else {
                console.log('参加者なのでボタンは非表示');
            }
        }

        // 次のラウンド
        function nextRound() {
            if (!isHost) return;
            
            console.log('次のラウンドボタンクリック。現在ラウンド:', gameState.round); // デバッグ用
            
            if (gameState.round > 10) { // 10ラウンド完了後は終了
                console.log('10ラウンド完了 - ゲーム終了'); // デバッグ用
                endGame();
                return;
            }
            
            // フェーズをplayingに戻すだけ（ラウンド数は変更しない）
            currentRoom.phase = 'playing';
            localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
            
            // ゲーム状態を更新
            gameState.phase = 'playing';
            
            console.log('次のラウンド開始。ラウンド:', gameState.round, 'フェーズ:', gameState.phase); // デバッグ用
            
            document.getElementById('roundResults').classList.add('hidden');
            document.getElementById('nextRoundBtn').classList.add('hidden');
            
            updateGameDisplay();
        }

        // ゲーム終了
        function endGame() {
            console.log('🏁 ゲーム終了処理開始。ホスト:', isHost);
            console.log('現在のゲーム状態:', gameState);
            console.log('現在のルーム状態:', currentRoom);
            
            loadPlayers();
            
            console.log('プレイヤー一覧:', players.map(p => `${p.name}:${p.score}点`));
            
            // 最終スコア計算
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            const maxScore = sortedPlayers[0].score;
            const winners = sortedPlayers.filter(player => player.score === maxScore);
            
            console.log('最終順位:', sortedPlayers.map(p => `${p.name}:${p.score}点`));
            console.log('勝者:', winners.map(w => w.name));
            
            // 結果表示
            const finalResults = document.getElementById('finalResults');
            const winnerAnnouncement = document.getElementById('winnerAnnouncement');
            const finalScores = document.getElementById('finalScores');
            
            if (!finalResults || !winnerAnnouncement || !finalScores) {
                console.error('❌ 最終結果表示要素が見つかりません');
                console.log('finalResults:', !!finalResults);
                console.log('winnerAnnouncement:', !!winnerAnnouncement);
                console.log('finalScores:', !!finalScores);
                return;
            }
            
            if (winners.length === 1) {
                winnerAnnouncement.textContent = `🎉 ${winners[0].name} の勝利！`;
                console.log('勝者発表:', winners[0].name);
            } else {
                const winnerNames = winners.map(w => w.name).join(', ');
                winnerAnnouncement.textContent = `🎉 引き分け！ ${winnerNames}`;
                console.log('引き分け発表:', winnerNames);
            }
            
            finalScores.innerHTML = '';
            sortedPlayers.forEach((player, index) => {
                const scoreItem = document.createElement('div');
                scoreItem.style.cssText = 'padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 10px; display: flex; justify-content: space-between; align-items: center;';
                
                const rank = index + 1;
                let medal = '';
                if (rank === 1) medal = '🥇';
                else if (rank === 2) medal = '🥈';
                else if (rank === 3) medal = '🥉';
                
                scoreItem.innerHTML = `
                    <span style="font-size: 1.2em;">${medal} ${rank}位: ${player.name}</span>
                    <span style="font-size: 1.3em; font-weight: bold; color: #4CAF50;">${player.score}ポイント</span>
                `;
                
                finalScores.appendChild(scoreItem);
                console.log(`順位表示追加: ${rank}位 ${player.name} ${player.score}点`);
            });
            
            // 他の画面を非表示にして最終結果を表示
            document.getElementById('roundResults').classList.add('hidden');
            document.getElementById('nextRoundBtn').classList.add('hidden');
            finalResults.classList.remove('hidden');
            
            console.log('最終結果画面の表示状態:', finalResults.classList.contains('hidden') ? '非表示' : '表示中');
            console.log('✅ 最終結果画面を表示しました');
            
            // ホストの場合のみ、ゲーム状態を確実に保存
            if (isHost) {
                console.log('ホストとして最終状態を保存');
                currentRoom.phase = 'finished';
                localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
                console.log('✅ finished状態を保存完了');
            }
        }

        // ルーム退出
        function leaveRoom() {
            stopUpdates();
            
            if (currentRoom && currentPlayer) {
                // プレイヤーをルームから削除
                loadPlayers();
                const remainingPlayers = players.filter(p => p.id !== currentUserId);
                
                // ホストが抜ける場合は次の人をホストに
                if (isHost && remainingPlayers.length > 0) {
                    remainingPlayers[0].isHost = true;
                }
                
                localStorage.setItem(`room_${currentRoom.code}_players`, JSON.stringify(remainingPlayers));
                
                // ルームが空になったら削除
                if (remainingPlayers.length === 0) {
                    localStorage.removeItem(`room_${currentRoom.code}`);
                    localStorage.removeItem(`room_${currentRoom.code}_players`);
                }
            }
            
            // 状態リセット
            currentRoom = null;
            currentPlayer = null;
            players = [];
            gameState = null;
            isHost = false;
            
            localStorage.removeItem('currentRoom');
            localStorage.removeItem('currentPlayerName');
            
            // 画面切り替え
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('finalResults').classList.add('hidden');
            document.getElementById('roundResults').classList.add('hidden');
            document.getElementById('roomSelection').classList.remove('hidden');
            
            // フォームリセット
            document.getElementById('roomCode').value = '';
        }

        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (currentRoom && currentPlayer) {
                loadPlayers();
                const remainingPlayers = players.filter(p => p.id !== currentUserId);
                
                if (isHost && remainingPlayers.length > 0) {
                    remainingPlayers[0].isHost = true;
                }
                
                localStorage.setItem(`room_${currentRoom.code}_players`, JSON.stringify(remainingPlayers));
                
                if (remainingPlayers.length === 0) {
                    localStorage.removeItem(`room_${currentRoom.code}`);
                    localStorage.removeItem(`room_${currentRoom.code}_players`);
                }
            }
        });
    </script>
</body>
</html>