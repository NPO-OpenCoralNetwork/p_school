<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ« - ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ç‰ˆ</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .setup-section {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .input-group input {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            margin: 5px;
            width: 250px;
        }

        .btn {
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .room-code {
            font-size: 2em;
            color: #FFD700;
            background: rgba(255,255,255,0.2);
            padding: 15px 30px;
            border-radius: 15px;
            margin: 20px 0;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .info-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .info-card h3 {
            margin-top: 0;
            color: #FFD700;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .player-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 3px solid transparent;
        }

        .player-card.current-user {
            border-color: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }

        .player-card.ready {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .player-score {
            font-size: 1.1em;
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .player-status {
            font-size: 0.9em;
            margin-bottom: 10px;
            padding: 5px 10px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }

        .hand {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
        }

        .card {
            width: 50px;
            height: 70px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            color: #333;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .card:hover:not(.disabled) {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
        }

        .card.selected {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            transform: translateY(-5px) scale(1.1);
            border-color: #FF6B35;
        }

        .card.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .submitted-card {
            width: 80px;
            height: 110px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: 3px solid #2E7D32;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            margin: 10px auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .submitted-card.winner {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-color: #FF6B35;
            animation: winner-glow 2s ease-in-out;
        }

        @keyframes winner-glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6); }
        }

        .round-results {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .result-item {
            text-align: center;
        }

        .result-card {
            width: 60px;
            height: 80px;
            margin: 0 auto 10px;
            background: linear-gradient(45deg, #fff, #f0f0f0);
            color: #333;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .result-card.rank-1 {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-color: #FF6B35;
        }

        .result-card.rank-2 {
            background: linear-gradient(45deg, #C0C0C0, #A0A0A0);
            border-color: #808080;
        }

        .result-card.rank-3 {
            background: linear-gradient(45deg, #CD7F32, #B8860B);
            border-color: #8B4513;
        }

        .status {
            font-size: 1.5em;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .final-results {
            background: rgba(255,255,255,0.15);
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px solid rgba(255,215,0,0.3);
        }

        .winner-announcement {
            font-size: 2.5em;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: winner-text 2s ease-in-out infinite;
        }

        @keyframes winner-text {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
        }

        .instructions {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .instructions h3 {
            color: #FFD700;
            margin-top: 0;
        }

        .instructions ol {
            line-height: 1.8;
        }

        @media (max-width: 768px) {
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            .hand {
                gap: 5px;
            }
            
            .card {
                width: 40px;
                height: 55px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸƒ æ•°å­—ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ« - ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ç‰ˆ</h1>
        
        <!-- æ¥ç¶šçŠ¶æ³è¡¨ç¤º -->
        <div class="connection-status">
            ãƒ­ãƒ¼ã‚«ãƒ«æ¥ç¶š
        </div>

        <!-- ãƒ«ãƒ¼ãƒ ä½œæˆãƒ»å‚åŠ ç”»é¢ -->
        <div id="roomSelection" class="setup-section">
            <h2>ãƒ«ãƒ¼ãƒ ä½œæˆãƒ»å‚åŠ </h2>
            
            <div class="instructions">
                <h3>ğŸ“± è¤‡æ•°äººãƒ—ãƒ¬ã‚¤ã®æ–¹æ³•</h3>
                <ol>
                    <li><strong>ãƒ›ã‚¹ãƒˆï¼ˆ1äººç›®ï¼‰</strong>ï¼šã€Œæ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    <li><strong>ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</strong>ï¼šæ–°ã—ã„ã‚¿ãƒ–ã‚’é–‹ã„ã¦ã“ã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                    <li>è¡¨ç¤ºã•ã‚ŒãŸãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦å‚åŠ </li>
                    <li>å…¨å“¡æƒã£ãŸã‚‰ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ é–‹å§‹</li>
                </ol>
                <p><strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆï¼š</strong> åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã§è¤‡æ•°ã‚¿ãƒ–ã‚’é–‹ã„ã¦1äººã§è¤‡æ•°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ï¼</p>
            </div>
            
            <div class="input-group">
                <label for="playerName">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:</label>
                <input type="text" id="playerName" placeholder="ã‚ãªãŸã®åå‰" maxlength="20">
            </div>
            
            <div style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
                <button class="btn btn-primary" onclick="createRoom()">æ–°ã—ã„ãƒ«ãƒ¼ãƒ ä½œæˆ</button>
            </div>
            
            <div class="input-group">
                <label for="roomCode">ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰:</label>
                <input type="text" id="roomCode" placeholder="ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" maxlength="6">
                <button class="btn btn-secondary" onclick="joinRoom()">å‚åŠ </button>
            </div>
            
            <div id="errorMessage" class="error-message hidden"></div>
        </div>

        <!-- å¾…æ©Ÿç”»é¢ -->
        <div id="waitingRoom" class="setup-section hidden">
            <h2>ãƒ«ãƒ¼ãƒ å¾…æ©Ÿä¸­</h2>
            <div id="roomCodeDisplay" class="room-code"></div>
            <div id="waitingPlayers" class="players-grid"></div>
            <div id="waitingStatus" class="status">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
            <div style="margin: 20px 0;">
                <button id="startGameBtn" class="btn btn-primary hidden" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                <button class="btn btn-secondary" onclick="leaveRoom()">ãƒ«ãƒ¼ãƒ ã‚’å‡ºã‚‹</button>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="gameScreen" class="hidden">
            <!-- ã‚²ãƒ¼ãƒ æƒ…å ± -->
            <div class="game-info">
                <div class="info-card">
                    <h3>ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰</h3>
                    <div id="currentRound" style="font-size: 2em;">1</div>
                </div>
                <div class="info-card">
                    <h3>ä»Šå›ã®ãƒã‚¤ãƒ³ãƒˆ</h3>
                    <div id="currentPoints" style="font-size: 2em; color: #FFD700;">1</div>
                </div>
                <div class="info-card">
                    <h3>æå‡ºæ¸ˆã¿</h3>
                    <div id="submittedCount" style="font-size: 2em;">0</div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
            <div id="gameStatus" class="status">ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§æå‡ºã—ã¦ãã ã•ã„</div>

            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º -->
            <div id="playersGrid" class="players-grid"></div>

            <!-- ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ -->
            <div id="roundResults" class="round-results hidden">
                <h3>ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ</h3>
                <div id="resultsGrid" class="results-grid"></div>
                <button id="nextRoundBtn" class="btn btn-primary hidden" onclick="nextRound()">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰</button>
            </div>

            <!-- æœ€çµ‚çµæœ -->
            <div id="finalResults" class="final-results hidden">
                <div id="winnerAnnouncement" class="winner-announcement"></div>
                <div id="finalScores"></div>
                <button class="btn btn-secondary" onclick="leaveRoom()">æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn btn-secondary" onclick="leaveRoom()">ãƒ«ãƒ¼ãƒ ã‚’å‡ºã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ã«ä½¿ç”¨
        let currentUserId = null;
        let currentRoom = null;
        let currentPlayer = null;
        let players = [];
        let gameState = null;
        let isHost = false;
        let updateInterval = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
            
            // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’ç¢ºèª
            const existingRoom = localStorage.getItem('currentRoom');
            if (existingRoom) {
                try {
                    currentRoom = JSON.parse(existingRoom);
                    const playerName = localStorage.getItem('currentPlayerName');
                    if (playerName) {
                        document.getElementById('playerName').value = playerName;
                        rejoinRoom();
                    }
                } catch (e) {
                    // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ç„¡è¦–
                    localStorage.removeItem('currentRoom');
                }
            }
            
            // é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
            const savedSelectedCard = sessionStorage.getItem('selectedCard');
            if (savedSelectedCard) {
                // ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿å¾Œã‚‚é¸æŠçŠ¶æ…‹ã‚’ç¶­æŒ
                setTimeout(() => {
                    if (currentPlayer && !currentPlayer.submittedCard) {
                        currentPlayer.selectedCard = parseInt(savedSelectedCard);
                        updatePlayersDisplay();
                    }
                }, 1000);
            }
        });

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // ãƒ«ãƒ¼ãƒ ä½œæˆ
        function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showError('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const roomCode = generateRoomCode();
            
            currentRoom = {
                code: roomCode,
                status: 'waiting',
                round: 1,
                points: 1,
                phase: 'waiting',
                createdAt: Date.now()
            };
            
            currentPlayer = {
                id: currentUserId,
                name: playerName,
                score: 0,
                hand: [1,2,3,4,5,6,7,8,9,10],
                selectedCard: null,
                submittedCard: null,
                isHost: true
            };
            
            isHost = true;
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('currentRoom', JSON.stringify(currentRoom));
            localStorage.setItem('currentPlayerName', playerName);
            localStorage.setItem(`room_${roomCode}`, JSON.stringify(currentRoom));
            localStorage.setItem(`room_${roomCode}_players`, JSON.stringify([currentPlayer]));
            
            enterWaitingRoom();
        }

        // ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        // ãƒ«ãƒ¼ãƒ å‚åŠ 
        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!roomCode) {
                showError('ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!playerName) {
                showError('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // ãƒ«ãƒ¼ãƒ å­˜åœ¨ç¢ºèª
            const roomData = localStorage.getItem(`room_${roomCode}`);
            if (!roomData) {
                showError('ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                currentRoom = JSON.parse(roomData);
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§å–å¾—
                const playersData = localStorage.getItem(`room_${roomCode}_players`);
                const existingPlayers = playersData ? JSON.parse(playersData) : [];
                
                // åŒåãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (existingPlayers.some(p => p.name === playerName)) {
                    showError('åŒã˜åå‰ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
                    return;
                }
                
                // äººæ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
                if (existingPlayers.length >= 8) {
                    showError('ãƒ«ãƒ¼ãƒ ãŒæº€å“¡ã§ã™');
                    return;
                }
                
                currentPlayer = {
                    id: currentUserId,
                    name: playerName,
                    score: 0,
                    hand: [1,2,3,4,5,6,7,8,9,10],
                    selectedCard: null,
                    submittedCard: null,
                    isHost: false
                };
                
                isHost = false;
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
                existingPlayers.push(currentPlayer);
                localStorage.setItem(`room_${roomCode}_players`, JSON.stringify(existingPlayers));
                localStorage.setItem('currentRoom', JSON.stringify(currentRoom));
                localStorage.setItem('currentPlayerName', playerName);
                
                if (currentRoom.status === 'waiting') {
                    enterWaitingRoom();
                } else {
                    enterGameRoom();
                }
                
            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒ å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒ«ãƒ¼ãƒ å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ«ãƒ¼ãƒ å†å‚åŠ 
        function rejoinRoom() {
            if (!currentRoom) return;
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±å¾©å…ƒ
            const playersData = localStorage.getItem(`room_${currentRoom.code}_players`);
            if (playersData) {
                const existingPlayers = JSON.parse(playersData);
                const player = existingPlayers.find(p => p.id === currentUserId);
                if (player) {
                    currentPlayer = player;
                    isHost = player.isHost;
                    
                    if (currentRoom.status === 'waiting') {
                        enterWaitingRoom();
                    } else {
                        enterGameRoom();
                    }
                }
            }
        }

        // å¾…æ©Ÿãƒ«ãƒ¼ãƒ å…¥å®¤
        function enterWaitingRoom() {
            document.getElementById('roomSelection').classList.add('hidden');
            document.getElementById('waitingRoom').classList.remove('hidden');
            
            document.getElementById('roomCodeDisplay').textContent = `ãƒ«ãƒ¼ãƒ ã‚³ãƒ¼ãƒ‰: ${currentRoom.code}`;
            
            // å®šæœŸæ›´æ–°é–‹å§‹
            startUpdates();
            updateWaitingRoom();
        }

        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ å…¥å®¤
        function enterGameRoom() {
            document.getElementById('roomSelection').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // å®šæœŸæ›´æ–°é–‹å§‹
            startUpdates();
            loadGameState();
            updateGameDisplay();
        }

        // å®šæœŸæ›´æ–°é–‹å§‹
        function startUpdates() {
            if (updateInterval) clearInterval(updateInterval);
            
            updateInterval = setInterval(() => {
                if (currentRoom) {
                    const oldStatus = currentRoom.status;
                    const oldPhase = gameState ? gameState.phase : null;
                    
                    loadPlayers();
                    loadGameState();
                    
                    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰åŒ–ãƒã‚§ãƒƒã‚¯
                    if (oldStatus === 'waiting' && currentRoom.status === 'playing') {
                        // ã‚²ãƒ¼ãƒ é–‹å§‹ã•ã‚ŒãŸ
                        if (!document.getElementById('gameScreen').classList.contains('hidden')) {
                            updateGameDisplay();
                        } else {
                            enterGameRoom();
                        }
                    }
                    
                    // ãƒ•ã‚§ãƒ¼ã‚ºå¤‰åŒ–ãƒã‚§ãƒƒã‚¯ï¼ˆresults â†’ playingï¼‰
                    if (oldPhase === 'results' && gameState.phase === 'playing') {
                        console.log('ğŸ”„ æ–°ã—ã„ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹ - çµæœç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¾ã™');
                        document.getElementById('roundResults').classList.add('hidden');
                        document.getElementById('nextRoundBtn').classList.add('hidden');
                    }
                    
                    if (!document.getElementById('waitingRoom').classList.contains('hidden')) {
                        updateWaitingRoom();
                    } else if (!document.getElementById('gameScreen').classList.contains('hidden')) {
                        updateGameDisplay();
                        
                        // çµæœãƒ•ã‚§ãƒ¼ã‚ºã®å‡¦ç†
                        if (gameState && gameState.phase === 'results' && currentRoom.lastResults) {
                            if (document.getElementById('roundResults').classList.contains('hidden')) {
                                showRoundResults(currentRoom.lastResults, true);
                            }
                        }
                        
                        // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ•ã‚§ãƒ¼ã‚ºã®å‡¦ç†
                        if (gameState && gameState.phase === 'finished') {
                            console.log('ğŸ ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ•ã‚§ãƒ¼ã‚ºæ¤œå‡ºã€‚ãƒ›ã‚¹ãƒˆ:', isHost);
                            if (document.getElementById('finalResults').classList.contains('hidden')) {
                                console.log('ğŸ’¡ æœ€çµ‚çµæœç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™');
                                endGame();
                            } else {
                                console.log('â„¹ï¸ æœ€çµ‚çµæœç”»é¢ã¯æ—¢ã«è¡¨ç¤ºæ¸ˆã¿');
                            }
                        }
                    }
                }
            }, 500); // æ›´æ–°é »åº¦ã‚’ä¸Šã’ã‚‹
        }

        // å®šæœŸæ›´æ–°åœæ­¢
        function stopUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§èª­ã¿è¾¼ã¿
        function loadPlayers() {
            if (!currentRoom) return;
            
            const playersData = localStorage.getItem(`room_${currentRoom.code}_players`);
            if (playersData) {
                const loadedPlayers = JSON.parse(playersData);
                
                // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æå‡ºæ¸ˆã¿çŠ¶æ…‹ã‚’ç¢ºèª
                const currentInLoaded = loadedPlayers.find(p => p.id === currentUserId);
                const hasSubmitted = currentPlayer && currentPlayer.submittedCard !== null;
                
                players = loadedPlayers;
                
                // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±æ›´æ–°
                const updated = players.find(p => p.id === currentUserId);
                if (updated) {
                    // æå‡ºæ¸ˆã¿ã®å ´åˆã¯é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                    if (updated.submittedCard !== null) {
                        sessionStorage.removeItem('selectedCard');
                        currentPlayer = updated;
                    } else {
                        // æœªæå‡ºã®å ´åˆã®ã¿é¸æŠçŠ¶æ…‹ã‚’ä¿æŒ
                        const savedSelectedCard = sessionStorage.getItem('selectedCard');
                        currentPlayer = updated;
                        if (savedSelectedCard && !hasSubmitted) {
                            currentPlayer.selectedCard = parseInt(savedSelectedCard);
                        }
                    }
                }
            }
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹èª­ã¿è¾¼ã¿
        function loadGameState() {
            if (!currentRoom) return;
            
            const roomData = localStorage.getItem(`room_${currentRoom.code}`);
            if (roomData) {
                const room = JSON.parse(roomData);
                currentRoom = room;
                gameState = {
                    round: room.round || 1,
                    points: room.points || 1,
                    phase: room.phase || 'waiting'
                };
            }
        }

        // å¾…æ©Ÿãƒ«ãƒ¼ãƒ è¡¨ç¤ºæ›´æ–°
        function updateWaitingRoom() {
            if (document.getElementById('waitingRoom').classList.contains('hidden')) return;
            
            loadPlayers();
            loadGameState();
            
            // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒã‚§ãƒƒã‚¯
            if (currentRoom && currentRoom.status === 'playing') {
                enterGameRoom();
                return;
            }
            
            const waitingPlayers = document.getElementById('waitingPlayers');
            waitingPlayers.innerHTML = '';
            
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                if (player.id === currentUserId) {
                    playerCard.classList.add('current-user');
                }
                
                let hostBadge = player.isHost ? ' ğŸ‘‘' : '';
                
                playerCard.innerHTML = `
                    <div class="player-name">${player.name}${hostBadge}</div>
                    <div class="player-status">å¾…æ©Ÿä¸­</div>
                `;
                
                waitingPlayers.appendChild(playerCard);
            });
            
            // ãƒ›ã‚¹ãƒˆãªã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³è¡¨ç¤º
            const hasEnoughPlayers = players.length >= 2;
            
            if (isHost && hasEnoughPlayers) {
                document.getElementById('startGameBtn').classList.remove('hidden');
            } else {
                document.getElementById('startGameBtn').classList.add('hidden');
            }
            
            // çŠ¶æ…‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const waitingStatus = document.getElementById('waitingStatus');
            if (players.length < 2) {
                waitingStatus.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™... (${players.length}/2äººä»¥ä¸Š)`;
            } else if (isHost) {
                waitingStatus.textContent = 'ã‚²ãƒ¼ãƒ é–‹å§‹ã®æº–å‚™ãŒã§ãã¾ã—ãŸï¼';
            } else {
                waitingStatus.textContent = 'ãƒ›ã‚¹ãƒˆã®ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...';
            }
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            if (!isHost) {
                showError('ãƒ›ã‚¹ãƒˆã®ã¿ãŒã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã™');
                return;
            }
            
            currentRoom.status = 'playing';
            currentRoom.phase = 'playing';
            
            localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
            
            enterGameRoom();
        }

        // ã‚²ãƒ¼ãƒ ç”»é¢è¡¨ç¤ºæ›´æ–°
        function updateGameDisplay() {
            if (document.getElementById('gameScreen').classList.contains('hidden')) return;
            
            loadPlayers();
            loadGameState();
            
            // ã‚²ãƒ¼ãƒ æƒ…å ±æ›´æ–°
            document.getElementById('currentRound').textContent = gameState?.round || 1;
            document.getElementById('currentPoints').textContent = gameState?.points || 1;
            
            // æå‡ºæ¸ˆã¿æ•°
            const submittedCount = players.filter(p => p.submittedCard !== null).length;
            document.getElementById('submittedCount').textContent = `${submittedCount}/${players.length}`;
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤º
            updatePlayersDisplay();
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateGameStatus();
            
            // çµæœè¡¨ç¤ºãƒã‚§ãƒƒã‚¯
            if (gameState && gameState.phase === 'results' && currentRoom.lastResults) {
                if (document.getElementById('roundResults').classList.contains('hidden')) {
                    showRoundResults(currentRoom.lastResults, true);
                }
            }
            
            // å…¨å“¡æå‡ºãƒã‚§ãƒƒã‚¯ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰
            if (isHost && submittedCount === players.length && submittedCount > 0 && gameState.phase === 'playing') {
                const allSubmitted = players.every(p => p.submittedCard !== null);
                if (allSubmitted) {
                    setTimeout(() => resolveRound(), 1000);
                }
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºæ›´æ–°
        function updatePlayersDisplay() {
            const playersGrid = document.getElementById('playersGrid');
            playersGrid.innerHTML = '';
            
            players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                
                if (player.id === currentUserId) {
                    playerCard.classList.add('current-user');
                }
                
                if (player.submittedCard !== null) {
                    playerCard.classList.add('ready');
                }
                
                const playerName = document.createElement('div');
                playerName.className = 'player-name';
                playerName.textContent = player.name;
                
                const playerScore = document.createElement('div');
                playerScore.className = 'player-score';
                playerScore.textContent = `ã‚¹ã‚³ã‚¢: ${player.score}`;
                
                const hand = document.createElement('div');
                hand.className = 'hand';
                
                // æ‰‹æœ­è¡¨ç¤ºï¼ˆè‡ªåˆ†ã®ã¿è©³ç´°è¡¨ç¤ºï¼‰
                if (player.id === currentUserId) {
                    const handArray = player.hand || [1,2,3,4,5,6,7,8,9,10];
                    
                    handArray.forEach(cardValue => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.textContent = cardValue;
                        
                        if (player.selectedCard === cardValue) {
                            card.classList.add('selected');
                        }
                        
                        if (player.submittedCard !== null) {
                            card.classList.add('disabled');
                        } else if (gameState && gameState.phase === 'playing') {
                            card.onclick = () => selectCard(cardValue);
                        } else {
                            card.classList.add('disabled');
                        }
                        
                        hand.appendChild(card);
                    });
                    
                    // ç¢ºå®šãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                    if (player.submittedCard === null && gameState && gameState.phase === 'playing') {
                        const buttonContainer = document.createElement('div');
                        buttonContainer.style.cssText = 'margin-top: 15px; display: flex; gap: 10px; justify-content: center;';
                        
                        if (player.selectedCard !== null) {
                            const confirmBtn = document.createElement('button');
                            confirmBtn.className = 'btn btn-primary';
                            confirmBtn.style.cssText = 'padding: 8px 16px; font-size: 14px;';
                            confirmBtn.textContent = `${player.selectedCard}ã‚’ç¢ºå®š`;
                            confirmBtn.onclick = confirmCard;
                            
                            const cancelBtn = document.createElement('button');
                            cancelBtn.className = 'btn btn-secondary';
                            cancelBtn.style.cssText = 'padding: 8px 16px; font-size: 14px;';
                            cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                            cancelBtn.onclick = cancelCardSelection;
                            
                            buttonContainer.appendChild(confirmBtn);
                            buttonContainer.appendChild(cancelBtn);
                        } else {
                            const selectMsg = document.createElement('div');
                            selectMsg.style.cssText = 'color: #FFD700; font-size: 14px; padding: 8px;';
                            selectMsg.textContent = 'ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„';
                            buttonContainer.appendChild(selectMsg);
                        }
                        
                        hand.appendChild(buttonContainer);
                    }
                    
                } else {
                    // ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ï¼ˆã‚«ãƒ¼ãƒ‰æ•°ã®ã¿è¡¨ç¤ºï¼‰
                    const handArray = player.hand || [];
                    const cardCount = handArray.length;
                    
                    for (let i = 0; i < cardCount; i++) {
                        const card = document.createElement('div');
                        card.className = 'card disabled';
                        card.textContent = '?';
                        hand.appendChild(card);
                    }
                }
                
                // æå‡ºæ¸ˆã¿ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
                if (player.submittedCard !== null) {
                    const submittedCard = document.createElement('div');
                    submittedCard.className = 'submitted-card';
                    submittedCard.textContent = player.submittedCard;
                    hand.appendChild(submittedCard);
                }
                
                playerCard.appendChild(playerName);
                playerCard.appendChild(playerScore);
                playerCard.appendChild(hand);
                playersGrid.appendChild(playerCard);
            });
        }

        // ã‚²ãƒ¼ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateGameStatus() {
            const status = document.getElementById('gameStatus');
            
            const submittedCount = players.filter(p => p.submittedCard !== null).length;
            const totalPlayers = players.length;
            
            if (currentPlayer && currentPlayer.submittedCard !== null) {
                status.textContent = `ã‚«ãƒ¼ãƒ‰ã‚’æå‡ºã—ã¾ã—ãŸã€‚ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™... (${submittedCount}/${totalPlayers})`;
            } else if (submittedCount === 0) {
                status.textContent = 'ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§æå‡ºã—ã¦ãã ã•ã„';
            } else {
                status.textContent = `${totalPlayers - submittedCount}äººã®æå‡ºã‚’å¾…ã£ã¦ã„ã¾ã™...`;
            }
        }

        // ã‚«ãƒ¼ãƒ‰é¸æŠ
        function selectCard(cardValue) {
            if (!currentPlayer || currentPlayer.submittedCard !== null) return;
            
            console.log('ã‚«ãƒ¼ãƒ‰é¸æŠ:', cardValue); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆã¾ã æå‡ºã¯ã—ãªã„ï¼‰
            currentPlayer.selectedCard = cardValue;
            
            // é¸æŠçŠ¶æ…‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¸€æ™‚ä¿å­˜ï¼ˆå®šæœŸæ›´æ–°ã§æ¶ˆãˆãªã„ã‚ˆã†ã«ï¼‰
            sessionStorage.setItem('selectedCard', cardValue);
            
            // ç”»é¢ã‚’å³åº§ã«æ›´æ–°ï¼ˆé¸æŠçŠ¶æ…‹ã‚’è¡¨ç¤ºï¼‰
            updatePlayersDisplay();
        }

        // ã‚«ãƒ¼ãƒ‰ç¢ºå®šãƒ»æå‡º
        function confirmCard() {
            if (!currentPlayer || !currentPlayer.selectedCard || currentPlayer.submittedCard !== null) return;
            
            console.log('ğŸ´ ã‚«ãƒ¼ãƒ‰ç¢ºå®šå‡¦ç†é–‹å§‹');
            console.log('é¸æŠã‚«ãƒ¼ãƒ‰:', currentPlayer.selectedCard);
            console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å:', currentPlayer.name);
            
            const cardToSubmit = currentPlayer.selectedCard;
            
            // æ‰‹æœ­ã‹ã‚‰å‰Šé™¤
            currentPlayer.hand = currentPlayer.hand.filter(card => card !== cardToSubmit);
            currentPlayer.submittedCard = cardToSubmit;
            currentPlayer.selectedCard = null;
            
            // é¸æŠçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
            sessionStorage.removeItem('selectedCard');
            
            // ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const playersData = localStorage.getItem(`room_${currentRoom.code}_players`);
            let allPlayers = playersData ? JSON.parse(playersData) : [];
            
            // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            allPlayers = allPlayers.map(p => 
                p.id === currentUserId ? { ...currentPlayer } : p
            );
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            localStorage.setItem(`room_${currentRoom.code}_players`, JSON.stringify(allPlayers));
            
            console.log('âœ… æå‡ºå®Œäº†');
            console.log('æ®‹ã‚Šæ‰‹æœ­:', currentPlayer.hand);
            console.log('æå‡ºã‚«ãƒ¼ãƒ‰:', currentPlayer.submittedCard);
            console.log('æ›´æ–°å¾Œã®å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:', allPlayers.map(p => `${p.name}:${p.submittedCard || 'æœªæå‡º'}`));
            
            // æ‰‹æœ­ãƒã‚§ãƒƒã‚¯ï¼ˆ10ãƒ©ã‚¦ãƒ³ãƒ‰å¾Œã§æ‰‹æœ­ãŒç©ºã®å ´åˆï¼‰
            if (currentPlayer.hand.length === 0) {
                console.log('ğŸ¯ æ‰‹æœ­ãŒç©ºã«ãªã‚Šã¾ã—ãŸ');
                loadGameState();
                if (gameState && gameState.round >= 10) {
                    console.log('ğŸ 10ãƒ©ã‚¦ãƒ³ãƒ‰å¾Œã«æ‰‹æœ­ãŒç©º - ã‚²ãƒ¼ãƒ çµ‚äº†ã‚’æ¤œå‡º');
                    setTimeout(() => {
                        console.log('ğŸ’¡ å‚åŠ è€…ã«ã‚ˆã‚‹å¼·åˆ¶ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†');
                        endGame();
                    }, 3000);
                }
            }
            
            // ç”»é¢æ›´æ–°ï¼ˆloadPlayersã‚’å‘¼ã°ãšã«ç›´æ¥æ›´æ–°ï¼‰
            updatePlayersDisplay();
            updateGameStatus();
            
            // å¼·åˆ¶çš„ã«ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            setTimeout(() => {
                console.log('â° æå‡ºå¾Œã®çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯');
                updateGameDisplay();
            }, 500);
        }

        // ã‚«ãƒ¼ãƒ‰é¸æŠã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelCardSelection() {
            if (!currentPlayer || currentPlayer.submittedCard !== null) return;
            
            currentPlayer.selectedCard = null;
            sessionStorage.removeItem('selectedCard');
            updatePlayersDisplay();
        }

        // ãƒ©ã‚¦ãƒ³ãƒ‰çµæœå‡¦ç†
        function resolveRound() {
            if (!isHost) return;
            
            // æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (currentRoom.phase !== 'playing') {
                console.log('âš ï¸ æ—¢ã«çµæœå‡¦ç†æ¸ˆã¿ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚ç¾åœ¨ãƒ•ã‚§ãƒ¼ã‚º:', currentRoom.phase);
                return;
            }
            
            console.log('ğŸ¯ ãƒ©ã‚¦ãƒ³ãƒ‰çµæœå‡¦ç†é–‹å§‹');
            
            // å³åº§ã«ãƒ•ã‚§ãƒ¼ã‚ºã‚’å¤‰æ›´ã—ã¦é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
            currentRoom.phase = 'resolving';
            localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
            
            loadPlayers();
            
            const submittedCards = players.map(p => ({
                player: p,
                card: p.submittedCard
            }));
            
            console.log('æå‡ºã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰:', submittedCards.map(c => `${c.player.name}:${c.card}`));
            
            // nullå€¤ãƒã‚§ãƒƒã‚¯
            const hasNullCards = submittedCards.some(c => c.card === null || c.card === undefined);
            if (hasNullCards) {
                console.log('âŒ æå‡ºã‚«ãƒ¼ãƒ‰ã«nullãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚å‡¦ç†ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚');
                currentRoom.phase = 'playing';
                localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
                return;
            }
            
            // é †ä½æ±ºå®š
            const rankings = calculateRankings(submittedCards);
            console.log('è¨ˆç®—ã•ã‚ŒãŸé †ä½:', rankings);
            
            // ãƒã‚¤ãƒ³ãƒˆé…å¸ƒ
            let pointAwarded = false;
            let newPoints = gameState.points;
            
            if (rankings.length > 0 && rankings[0].rank !== 'tie') {
                // 1ä½ã®äººãŒã„ã‚‹å ´åˆ
                const winner = rankings[0].players[0];
                console.log('å‹è€…:', winner.player.name, 'ç²å¾—ãƒã‚¤ãƒ³ãƒˆ:', newPoints);
                
                // å‹è€…ã®ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
                const winnerIndex = players.findIndex(p => p.id === winner.player.id);
                if (winnerIndex !== -1) {
                    players[winnerIndex].score += newPoints;
                }
                
                pointAwarded = true;
                newPoints = 1; // æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¯1ãƒã‚¤ãƒ³ãƒˆã«æˆ»ã‚‹
            } else {
                // å…¨å“¡åŒã˜ã®å ´åˆã€ãƒã‚¤ãƒ³ãƒˆç¹°ã‚Šè¶Šã—
                newPoints++;
                console.log('å¼•ãåˆ†ã‘ã€æ¬¡å›ãƒã‚¤ãƒ³ãƒˆ:', newPoints);
            }
            
            // æå‡ºã‚«ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
            players.forEach(player => {
                player.submittedCard = null;
                player.selectedCard = null;
            });
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
            const newRound = gameState.round + 1;
            const gameFinished = newRound > 10; // 11ãƒ©ã‚¦ãƒ³ãƒ‰ç›®ã«ãªã£ãŸã‚‰çµ‚äº†
            
            console.log('ç¾åœ¨ãƒ©ã‚¦ãƒ³ãƒ‰:', gameState.round, 'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰:', newRound, 'ã‚²ãƒ¼ãƒ çµ‚äº†:', gameFinished);
            
            currentRoom.round = newRound; // å¸¸ã«æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã«é€²ã‚ã‚‹
            currentRoom.points = newPoints;
            currentRoom.phase = gameFinished ? 'finished' : 'results';
            currentRoom.lastResults = rankings;
            
            // ä¿å­˜
            localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
            localStorage.setItem(`room_${currentRoom.code}_players`, JSON.stringify(players));
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°
            gameState = {
                round: currentRoom.round,
                points: currentRoom.points,
                phase: currentRoom.phase
            };
            
            console.log('âœ… ãƒ©ã‚¦ãƒ³ãƒ‰çµæœå‡¦ç†å®Œäº†ã€‚æ–°ã—ã„ãƒ•ã‚§ãƒ¼ã‚º:', currentRoom.phase);
            
            // çµæœè¡¨ç¤º
            showRoundResults(rankings, pointAwarded);
            
            // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
            if (gameFinished) {
                console.log('ğŸ ã‚²ãƒ¼ãƒ çµ‚äº†æ¡ä»¶é”æˆã€‚3ç§’å¾Œã«çµ‚äº†å‡¦ç†é–‹å§‹');
                setTimeout(() => {
                    console.log('ğŸ ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†ã‚’å®Ÿè¡Œ');
                    endGame();
                }, 3000);
            }
        }

        // é †ä½è¨ˆç®—
        function calculateRankings(submittedCards) {
            console.log('é †ä½è¨ˆç®—é–‹å§‹ã€‚æå‡ºã‚«ãƒ¼ãƒ‰:', submittedCards); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            // ã‚«ãƒ¼ãƒ‰ã®å€¤ã§é™é †ã‚½ãƒ¼ãƒˆ
            const sortedCards = [...submittedCards].sort((a, b) => b.card - a.card);
            console.log('ã‚½ãƒ¼ãƒˆå¾Œ:', sortedCards.map(c => `${c.player.name}:${c.card}`)); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            const rankings = [];
            let currentRank = 1;
            let i = 0;
            
            while (i < sortedCards.length) {
                const currentValue = sortedCards[i].card;
                const sameValuePlayers = sortedCards.filter(item => item.card === currentValue);
                
                console.log(`å€¤${currentValue}ã®åŒç‡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼:`, sameValuePlayers.length, 'äºº'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                
                if (sameValuePlayers.length === sortedCards.length) {
                    // å…¨å“¡åŒã˜å€¤ã®å ´åˆ
                    console.log('å…¨å“¡åŒã˜å€¤ - å¼•ãåˆ†ã‘'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                    rankings.push({
                        rank: 'tie',
                        players: sameValuePlayers,
                        value: currentValue
                    });
                    break;
                } else if (sameValuePlayers.length === 1) {
                    // å˜ç‹¬é †ä½ã®å ´åˆ
                    console.log(`${currentRank}ä½: ${sameValuePlayers[0].player.name} (${currentValue})`); // ãƒ‡ãƒãƒƒã‚°ç”¨
                    rankings.push({
                        rank: currentRank,
                        players: sameValuePlayers,
                        value: currentValue
                    });
                    currentRank++;
                    i++;
                } else {
                    // åŒé †ä½ãŒè¤‡æ•°ã„ã‚‹å ´åˆã€æ¬¡ã®é †ä½ã®äººã‚’æ¢ã™
                    console.log(`${currentValue}ã§${sameValuePlayers.length}äººãŒåŒç‡ - æ¬¡ã®é †ä½ã‚’æ¢ã™`); // ãƒ‡ãƒãƒƒã‚°ç”¨
                    i += sameValuePlayers.length;
                    if (i < sortedCards.length) {
                        currentRank = i + 1;
                        continue;
                    } else {
                        // ã“ã‚Œä»¥ä¸Šã®é †ä½ãŒãªã„å ´åˆã¯çµ‚äº†
                        break;
                    }
                }
            }
            
            console.log('æœ€çµ‚é †ä½:', rankings); // ãƒ‡ãƒãƒƒã‚°ç”¨
            return rankings;
        }

        // ãƒ©ã‚¦ãƒ³ãƒ‰çµæœè¡¨ç¤º
        function showRoundResults(rankings, pointAwarded) {
            console.log('ğŸŠ çµæœè¡¨ç¤ºé–‹å§‹ã€‚ãƒ›ã‚¹ãƒˆ:', isHost);
            console.log('è¡¨ç¤ºã™ã‚‹é †ä½:', rankings);
            console.log('ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹:', gameState);
            
            const roundResults = document.getElementById('roundResults');
            const resultsGrid = document.getElementById('resultsGrid');
            
            if (!roundResults || !resultsGrid) {
                console.error('âŒ çµæœè¡¨ç¤ºè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            resultsGrid.innerHTML = '';
            
            rankings.forEach((ranking, index) => {
                console.log(`é †ä½ ${ranking.rank}: ${ranking.players.length}äºº`);
                ranking.players.forEach(playerData => {
                    console.log(`  - ${playerData.player.name}: ${playerData.card}`);
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    
                    const resultCard = document.createElement('div');
                    resultCard.className = 'result-card';
                    resultCard.textContent = playerData.card;
                    
                    if (ranking.rank === 1) {
                        resultCard.classList.add('rank-1');
                    } else if (ranking.rank === 2) {
                        resultCard.classList.add('rank-2');
                    } else if (ranking.rank === 3) {
                        resultCard.classList.add('rank-3');
                    }
                    
                    const playerName = document.createElement('div');
                    playerName.textContent = playerData.player.name;
                    
                    const rankText = document.createElement('div');
                    if (ranking.rank === 'tie') {
                        rankText.textContent = 'å¼•ãåˆ†ã‘';
                        rankText.style.color = '#FFA500';
                    } else if (ranking.rank === 1 && pointAwarded) {
                        // ç²å¾—ãƒã‚¤ãƒ³ãƒˆã‚’æ­£ç¢ºã«è¡¨ç¤º
                        const actualPoints = gameState?.points || currentRoom?.points || 1;
                        rankText.textContent = `${actualPoints}ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼`;
                        rankText.style.color = '#4CAF50';
                    } else {
                        rankText.textContent = `${ranking.rank}ä½`;
                    }
                    
                    resultItem.appendChild(resultCard);
                    resultItem.appendChild(playerName);
                    resultItem.appendChild(rankText);
                    resultsGrid.appendChild(resultItem);
                });
            });
            
            console.log('çµæœã‚°ãƒªãƒƒãƒ‰ã«è¿½åŠ ã•ã‚ŒãŸè¦ç´ æ•°:', resultsGrid.children.length);
            
            // çµæœç”»é¢ã‚’è¡¨ç¤º
            roundResults.classList.remove('hidden');
            console.log('âœ… çµæœç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            
            // ãƒ›ã‚¹ãƒˆãªã‚‰æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãƒœã‚¿ãƒ³è¡¨ç¤º
            if (isHost) {
                console.log('ãƒ›ã‚¹ãƒˆãªã®ã§æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã€‚ç¾åœ¨ãƒ©ã‚¦ãƒ³ãƒ‰:', currentRoom.round);
                if (currentRoom.round > 10) { // 10ãƒ©ã‚¦ãƒ³ãƒ‰å®Œäº†å¾Œ
                    console.log('10ãƒ©ã‚¦ãƒ³ãƒ‰å®Œäº† - 3ç§’å¾Œã«ã‚²ãƒ¼ãƒ çµ‚äº†');
                    setTimeout(() => {
                        console.log('ğŸ ãƒ›ã‚¹ãƒˆã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†å®Ÿè¡Œ');
                        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«finishedã«è¨­å®š
                        currentRoom.phase = 'finished';
                        gameState.phase = 'finished';
                        localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
                        console.log('âœ… ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’finishedã«è¨­å®šå®Œäº†');
                        endGame();
                    }, 3000);
                } else {
                    document.getElementById('nextRoundBtn').classList.remove('hidden');
                    console.log('æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º');
                }
            } else {
                console.log('å‚åŠ è€…ãªã®ã§ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤º');
            }
        }

        // æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰
        function nextRound() {
            if (!isHost) return;
            
            console.log('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã€‚ç¾åœ¨ãƒ©ã‚¦ãƒ³ãƒ‰:', gameState.round); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            if (gameState.round > 10) { // 10ãƒ©ã‚¦ãƒ³ãƒ‰å®Œäº†å¾Œã¯çµ‚äº†
                console.log('10ãƒ©ã‚¦ãƒ³ãƒ‰å®Œäº† - ã‚²ãƒ¼ãƒ çµ‚äº†'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                endGame();
                return;
            }
            
            // ãƒ•ã‚§ãƒ¼ã‚ºã‚’playingã«æˆ»ã™ã ã‘ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã¯å¤‰æ›´ã—ãªã„ï¼‰
            currentRoom.phase = 'playing';
            localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°
            gameState.phase = 'playing';
            
            console.log('æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹ã€‚ãƒ©ã‚¦ãƒ³ãƒ‰:', gameState.round, 'ãƒ•ã‚§ãƒ¼ã‚º:', gameState.phase); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            document.getElementById('roundResults').classList.add('hidden');
            document.getElementById('nextRoundBtn').classList.add('hidden');
            
            updateGameDisplay();
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†
        function endGame() {
            console.log('ğŸ ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†é–‹å§‹ã€‚ãƒ›ã‚¹ãƒˆ:', isHost);
            console.log('ç¾åœ¨ã®ã‚²ãƒ¼ãƒ çŠ¶æ…‹:', gameState);
            console.log('ç¾åœ¨ã®ãƒ«ãƒ¼ãƒ çŠ¶æ…‹:', currentRoom);
            
            loadPlayers();
            
            console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§:', players.map(p => `${p.name}:${p.score}ç‚¹`));
            
            // æœ€çµ‚ã‚¹ã‚³ã‚¢è¨ˆç®—
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            const maxScore = sortedPlayers[0].score;
            const winners = sortedPlayers.filter(player => player.score === maxScore);
            
            console.log('æœ€çµ‚é †ä½:', sortedPlayers.map(p => `${p.name}:${p.score}ç‚¹`));
            console.log('å‹è€…:', winners.map(w => w.name));
            
            // çµæœè¡¨ç¤º
            const finalResults = document.getElementById('finalResults');
            const winnerAnnouncement = document.getElementById('winnerAnnouncement');
            const finalScores = document.getElementById('finalScores');
            
            if (!finalResults || !winnerAnnouncement || !finalScores) {
                console.error('âŒ æœ€çµ‚çµæœè¡¨ç¤ºè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                console.log('finalResults:', !!finalResults);
                console.log('winnerAnnouncement:', !!winnerAnnouncement);
                console.log('finalScores:', !!finalScores);
                return;
            }
            
            if (winners.length === 1) {
                winnerAnnouncement.textContent = `ğŸ‰ ${winners[0].name} ã®å‹åˆ©ï¼`;
                console.log('å‹è€…ç™ºè¡¨:', winners[0].name);
            } else {
                const winnerNames = winners.map(w => w.name).join(', ');
                winnerAnnouncement.textContent = `ğŸ‰ å¼•ãåˆ†ã‘ï¼ ${winnerNames}`;
                console.log('å¼•ãåˆ†ã‘ç™ºè¡¨:', winnerNames);
            }
            
            finalScores.innerHTML = '';
            sortedPlayers.forEach((player, index) => {
                const scoreItem = document.createElement('div');
                scoreItem.style.cssText = 'padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 10px; display: flex; justify-content: space-between; align-items: center;';
                
                const rank = index + 1;
                let medal = '';
                if (rank === 1) medal = 'ğŸ¥‡';
                else if (rank === 2) medal = 'ğŸ¥ˆ';
                else if (rank === 3) medal = 'ğŸ¥‰';
                
                scoreItem.innerHTML = `
                    <span style="font-size: 1.2em;">${medal} ${rank}ä½: ${player.name}</span>
                    <span style="font-size: 1.3em; font-weight: bold; color: #4CAF50;">${player.score}ãƒã‚¤ãƒ³ãƒˆ</span>
                `;
                
                finalScores.appendChild(scoreItem);
                console.log(`é †ä½è¡¨ç¤ºè¿½åŠ : ${rank}ä½ ${player.name} ${player.score}ç‚¹`);
            });
            
            // ä»–ã®ç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¦æœ€çµ‚çµæœã‚’è¡¨ç¤º
            document.getElementById('roundResults').classList.add('hidden');
            document.getElementById('nextRoundBtn').classList.add('hidden');
            finalResults.classList.remove('hidden');
            
            console.log('æœ€çµ‚çµæœç”»é¢ã®è¡¨ç¤ºçŠ¶æ…‹:', finalResults.classList.contains('hidden') ? 'éè¡¨ç¤º' : 'è¡¨ç¤ºä¸­');
            console.log('âœ… æœ€çµ‚çµæœç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            
            // ãƒ›ã‚¹ãƒˆã®å ´åˆã®ã¿ã€ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«ä¿å­˜
            if (isHost) {
                console.log('ãƒ›ã‚¹ãƒˆã¨ã—ã¦æœ€çµ‚çŠ¶æ…‹ã‚’ä¿å­˜');
                currentRoom.phase = 'finished';
                localStorage.setItem(`room_${currentRoom.code}`, JSON.stringify(currentRoom));
                console.log('âœ… finishedçŠ¶æ…‹ã‚’ä¿å­˜å®Œäº†');
            }
        }

        // ãƒ«ãƒ¼ãƒ é€€å‡º
        function leaveRoom() {
            stopUpdates();
            
            if (currentRoom && currentPlayer) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ«ãƒ¼ãƒ ã‹ã‚‰å‰Šé™¤
                loadPlayers();
                const remainingPlayers = players.filter(p => p.id !== currentUserId);
                
                // ãƒ›ã‚¹ãƒˆãŒæŠœã‘ã‚‹å ´åˆã¯æ¬¡ã®äººã‚’ãƒ›ã‚¹ãƒˆã«
                if (isHost && remainingPlayers.length > 0) {
                    remainingPlayers[0].isHost = true;
                }
                
                localStorage.setItem(`room_${currentRoom.code}_players`, JSON.stringify(remainingPlayers));
                
                // ãƒ«ãƒ¼ãƒ ãŒç©ºã«ãªã£ãŸã‚‰å‰Šé™¤
                if (remainingPlayers.length === 0) {
                    localStorage.removeItem(`room_${currentRoom.code}`);
                    localStorage.removeItem(`room_${currentRoom.code}_players`);
                }
            }
            
            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            currentRoom = null;
            currentPlayer = null;
            players = [];
            gameState = null;
            isHost = false;
            
            localStorage.removeItem('currentRoom');
            localStorage.removeItem('currentPlayerName');
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('finalResults').classList.add('hidden');
            document.getElementById('roundResults').classList.add('hidden');
            document.getElementById('roomSelection').classList.remove('hidden');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('roomCode').value = '';
        }

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (currentRoom && currentPlayer) {
                loadPlayers();
                const remainingPlayers = players.filter(p => p.id !== currentUserId);
                
                if (isHost && remainingPlayers.length > 0) {
                    remainingPlayers[0].isHost = true;
                }
                
                localStorage.setItem(`room_${currentRoom.code}_players`, JSON.stringify(remainingPlayers));
                
                if (remainingPlayers.length === 0) {
                    localStorage.removeItem(`room_${currentRoom.code}`);
                    localStorage.removeItem(`room_${currentRoom.code}_players`);
                }
            }
        });
    </script>
</body>
</html>